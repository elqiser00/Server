name: Upload to Telegram

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±'
        required: true
      image_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©'
        required: false
      caption:
        description: 'Ø§Ù„ÙƒØ§Ø¨Ø´Ù†'
        required: true
      movie_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
      content_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰'
        required: true
        default: 'movie'
        type: choice
        options:
          - movie
          - series

jobs:
  upload-to-telegram:
    runs-on: ubuntu-latest
    
    steps:
    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
      run: |
        echo "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª..."
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        if [ -n "${{ github.event.inputs.video_url }}" ]; then
          wget -O video.mp4 "${{ github.event.inputs.video_url }}"
          echo "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"
        fi
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if [ -n "${{ github.event.inputs.image_url }}" ]; then
          wget -O image.jpg "${{ github.event.inputs.image_url }}"
          echo "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©"
        fi
    
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        pip install telethon requests
    
    - name: Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Telegram
      env:
        API_ID: ${{ secrets.TELEGRAM_API_ID }}
        API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHANNEL_LINK: ${{ secrets.TELEGRAM_CHANNEL_LINK }}
      run: |
        python -c "
        import asyncio
        import os
        from telethon import TelegramClient
        import base64
        
        async def main():
            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
            client = TelegramClient(
                'github_uploader',
                int(os.getenv('API_ID')),
                os.getenv('API_HASH')
            )
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… session string
            session_str = os.getenv('SESSION_STRING')
            if session_str:
                import hashlib
                client.session.set_dc(2, '149.154.167.40', 80)
                client.session.auth_key.data = base64.b64decode(session_str)
            
            await client.connect()
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©
            entity = await client.get_entity(os.getenv('CHANNEL_LINK'))
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            caption = '''${{ github.event.inputs.caption }}
            
            ğŸ“¥ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±: ${{ github.event.inputs.video_url }}'''
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            if [ -f 'image.jpg' ]; then
                # Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ ØµÙˆØ±Ø©
                await client.send_file(
                    entity,
                    ['video.mp4', 'image.jpg'],
                    caption=caption,
                    supports_streaming=True
                )
            else:
                # Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©
                await client.send_file(
                    entity,
                    'video.mp4',
                    caption=caption,
                    supports_streaming=True
                )
            
            print('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!')
            await client.disconnect()
        
        asyncio.run(main())
        "
    
    - name: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
      run: |
        rm -f video.mp4 image.jpg
        echo "ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"
