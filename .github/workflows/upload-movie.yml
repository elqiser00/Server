name: ðŸŽ¬ Ø±ÙØ¹ ÙÙŠÙ„Ù… - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

on:
  workflow_dispatch:
    inputs:
      channel_link:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        type: string
      movie_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        type: string
      poster_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ³ØªØ±'
        required: true
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± mp4'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip wget ffmpeg
        pip3 install telethon

    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      run: |
        cat > upload.py << 'EOF'
        import asyncio, os, subprocess, sys
        from telethon import TelegramClient, types
        from telethon.sessions import StringSession

        API_ID = int(os.environ['TELEGRAM_API_ID'])
        API_HASH = os.environ['TELEGRAM_API_HASH']
        SESSION = os.environ['TELEGRAM_SESSION_STRING']

        CHANNEL = os.environ['CHANNEL_LINK']
        MOVIE = os.environ['MOVIE_NAME']
        POSTER_URL = os.environ['POSTER_URL']
        VIDEO_URL = os.environ['VIDEO_URL']

        POSTER = "poster.jpg"
        VIDEO = "video.mp4"

        async def download(url, out):
            cmd = ["wget", "-O", out, "--content-disposition", url]
            r = subprocess.run(cmd)
            if r.returncode != 0 or not os.path.exists(out):
                raise Exception(f"ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ {out}")

        def check_video(path):
            if os.path.getsize(path) < 5 * 1024 * 1024:
                raise Exception("Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ ÙÙŠØ¯ÙŠÙˆ Ø­Ù‚ÙŠÙ‚ÙŠ")
            probe = subprocess.run(
                ["ffprobe", "-v", "error", "-select_streams", "v:0",
                 "-show_entries", "stream=codec_type", "-of", "csv=p=0", path],
                capture_output=True, text=True
            )
            if "video" not in probe.stdout:
                raise Exception("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ù…Ø³Ø§Ø± ÙÙŠØ¯ÙŠÙˆ")

        async def main():
            await download(POSTER_URL, POSTER)
            await download(VIDEO_URL, VIDEO)
            check_video(VIDEO)

            client = TelegramClient(StringSession(SESSION), API_ID, API_HASH)
            await client.connect()
            if not await client.is_user_authorized():
                raise Exception("Ø¬Ù„Ø³Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± ØµØ§Ù„Ø­Ø©")

            channel = await client.get_entity(CHANNEL)

            photo = await client.upload_file(POSTER)
            video = await client.upload_file(VIDEO)

            media = [
                types.InputMediaUploadedPhoto(
                    file=photo,
                    caption=f"ðŸŽ¬ {MOVIE} - Ø¨ÙˆØ³ØªØ±"
                ),
                types.InputMediaUploadedDocument(
                    file=video,
                    mime_type="video/mp4",
                    attributes=[
                        types.DocumentAttributeVideo(
                            supports_streaming=True
                        )
                    ],
                    caption=f"ðŸŽ¥ {MOVIE}\nâœ… ÙÙŠÙ„Ù… ÙƒØ§Ù…Ù„"
                )
            ]

            await client.send_multi_media(channel, media)
            await client.disconnect()

        asyncio.run(main())
        EOF

    - name: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHANNEL_LINK: ${{ github.event.inputs.channel_link }}
        MOVIE_NAME: ${{ github.event.inputs.movie_name }}
        POSTER_URL: ${{ github.event.inputs.poster_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        python3 upload.py
