name: ğŸ¬ Ø±ÙØ¹ ÙÙŠÙ„Ù… - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

on:
  workflow_dispatch:
    inputs:
      channel_link:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        type: string
      movie_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        type: string
      poster_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ³ØªØ±'
        required: true
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± mp4'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        echo "ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª..."
        sudo apt update
        sudo apt install -y python3 python3-pip curl wget ffmpeg
        pip3 install telethon

    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      run: |
        echo "ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹..."
        cat > upload.py << 'EOF'
        import asyncio, os, subprocess, sys, logging
        
        logging.basicConfig(level=logging.INFO, format='%(message)s')
        logger = logging.getLogger(__name__)
        
        from telethon import TelegramClient, types
        from telethon.sessions import StringSession
        
        async def download_file(url, out):
            """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª"""
            try:
                logger.info(f"ğŸ“¥ ØªØ­Ù…ÙŠÙ„: {url}")
                
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… curl
                cmd = [
                    "curl", "-L",
                    "--insecure",
                    "--connect-timeout", "30",
                    "--max-time", "300",
                    "--retry", "2",
                    "--output", out,
                    url
                ]
                
                result = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
                
                if result.returncode == 0 and os.path.exists(out):
                    size = os.path.getsize(out)
                    if size > 0:
                        logger.info(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ {out} - {size/1024/1024:.2f} MB")
                        return True
                
                logger.error(f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„")
                return False
                
            except Exception as e:
                logger.error(f"âŒ Ø®Ø·Ø£: {e}")
                return False
        
        async def main():
            try:
                # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                API_ID = int(os.environ['TELEGRAM_API_ID'])
                API_HASH = os.environ['TELEGRAM_API_HASH']
                SESSION = os.environ['TELEGRAM_SESSION_STRING']
                CHANNEL = os.environ['CHANNEL_LINK']
                MOVIE = os.environ['MOVIE_NAME']
                POSTER_URL = os.environ['POSTER_URL']
                VIDEO_URL = os.environ['VIDEO_URL']
                
                logger.info("=" * 50)
                logger.info("ğŸš€ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠÙ„Ù…")
                logger.info(f"ğŸ¬ {MOVIE}")
                logger.info("=" * 50)
                
                # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
                logger.info("ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª...")
                
                # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                if not await download_file(POSTER_URL, "poster.jpg"):
                    raise Exception("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©")
                
                # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                if not await download_file(VIDEO_URL, "video.mp4"):
                    raise Exception("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
                
                # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                logger.info("ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…...")
                client = TelegramClient(StringSession(SESSION), API_ID, API_HASH)
                await client.connect()
                
                if not await client.is_user_authorized():
                    raise Exception("Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©")
                
                me = await client.get_me()
                logger.info(f"âœ… Ù…ØªØµÙ„ Ø¨Ù€: {me.first_name}")
                
                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©
                channel = await client.get_entity(CHANNEL)
                logger.info(f"ğŸ“¢ Ø§Ù„Ù‚Ù†Ø§Ø©: {channel.title}")
                
                # Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
                logger.info("â¬†ï¸ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...")
                photo = await client.upload_file("poster.jpg")
                
                logger.info("â¬†ï¸ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                video = await client.upload_file("video.mp4")
                
                # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                logger.info("ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©...")
                media = [
                    types.InputMediaUploadedPhoto(
                        file=photo,
                        caption=f"ğŸ¬ {MOVIE}"
                    ),
                    types.InputMediaUploadedDocument(
                        file=video,
                        mime_type="video/mp4",
                        attributes=[types.DocumentAttributeVideo(supports_streaming=True)],
                        caption=f"ğŸ¥ {MOVIE}\nâœ… ÙÙŠÙ„Ù… ÙƒØ§Ù…Ù„"
                    )
                ]
                
                await client.send_message(channel, file=media)
                logger.info("âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!")
                
                await client.disconnect()
                
                # ØªÙ†Ø¸ÙŠÙ
                os.remove("poster.jpg")
                os.remove("video.mp4")
                
            except Exception as e:
                logger.error(f"âŒ Ø®Ø·Ø£: {e}")
                raise
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ upload.py"

    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHANNEL_LINK: ${{ github.event.inputs.channel_link }}
        MOVIE_NAME: ${{ github.event.inputs.movie_name }}
        POSTER_URL: ${{ github.event.inputs.poster_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹..."
        python3 upload.py
        echo "ğŸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ†ÙÙŠØ°"

    - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo "ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ†ÙÙŠØ°:"
        echo "Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„ØªÙØ§ØµÙŠÙ„"
