name: Telegram Movie Uploader

on:
  workflow_dispatch:
    inputs:
      channel:
        description: 'Telegram Channel Link'
        required: true
        type: string
      movie:
        description: 'Movie Name'
        required: true
        type: string
      poster:
        description: 'Poster Image URL'
        required: true
        type: string
      video:
        description: 'Video File URL'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Install requirements
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip curl
        pip3 install telethon

    - name: Download files
      run: |
        curl -L --insecure -o poster.jpg "${{ github.event.inputs.poster }}"
        curl -L --insecure -o video.mp4 "${{ github.event.inputs.video }}"
        echo "Files downloaded"

    - name: Upload to Telegram
      env:
        API_ID: ${{ secrets.TELEGRAM_API_ID }}
        API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        SESSION: ${{ secrets.TELEGRAM_SESSION_STRING }}
      run: |
        python3 -c '
import asyncio, os
from telethon import TelegramClient
from telethon.sessions import StringSession

async def upload():
    # Connect to Telegram
    client = TelegramClient(
        StringSession(os.environ["SESSION"]),
        int(os.environ["API_ID"]),
        os.environ["API_HASH"]
    )
    
    await client.connect()
    
    if not await client.is_user_authorized():
        print("ERROR: Invalid session")
        return
    
    print("SUCCESS: Connected to Telegram")
    
    # Get channel
    channel = await client.get_entity("${{ github.event.inputs.channel }}")
    print(f"Channel: {channel.title}")
    
    # Send poster
    print("Sending poster...")
    await client.send_file(channel, "poster.jpg", caption="ðŸŽ¬ ${{ github.event.inputs.movie }}")
    print("Poster sent")
    
    # Send video
    print("Sending video...")
    video_size = os.path.getsize("video.mp4") / (1024 * 1024)
    caption = f"ðŸŽ¥ ${{ github.event.inputs.movie }}\\nâœ… Complete Movie\\nðŸ“Š Size: {video_size:.2f} MB"
    await client.send_file(channel, "video.mp4", caption=caption, supports_streaming=True)
    print("Video sent")
    
    await client.disconnect()
    print("DONE: Upload completed")

asyncio.run(upload())
'

    - name: Cleanup
      run: |
        rm -f poster.jpg video.mp4
        echo "Cleanup done"
