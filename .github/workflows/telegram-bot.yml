name: Movie Upload

on:
  workflow_dispatch:
    inputs:
      channel:
        description: 'Channel URL'
        required: true
      movie:
        description: 'Movie Name'
        required: true
      poster:
        description: 'Poster URL'
        required: true
      video:
        description: 'Video URL'
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip curl
        pip3 install telethon
        
    - name: Download
      run: |
        curl -L --insecure -o poster.jpg "${{ github.event.inputs.poster }}"
        curl -L --insecure -o video.mp4 "${{ github.event.inputs.video }}"
        
    - name: Run Upload
      env:
        API_ID: ${{ secrets.TELEGRAM_API_ID }}
        API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        SESSION: ${{ secrets.TELEGRAM_SESSION_STRING }}
      run: |
        python3 -c '
import asyncio, os
from telethon import TelegramClient
from telethon.sessions import StringSession

client = TelegramClient(
    StringSession(os.environ["SESSION"]),
    int(os.environ["API_ID"]),
    os.environ["API_HASH"]
)

async def main():
    await client.connect()
    
    if not await client.is_user_authorized():
        print("Error: Invalid session")
        return
    
    print("Connected to Telegram")
    
    channel = await client.get_entity("${{ github.event.inputs.channel }}")
    
    # Send poster
    await client.send_file(channel, "poster.jpg", caption="ðŸŽ¬ ${{ github.event.inputs.movie }}")
    print("Poster sent")
    
    # Send video
    video_size = os.path.getsize("video.mp4") / (1024 * 1024)
    caption = f"ðŸŽ¥ ${{ github.event.inputs.movie }}\\nâœ… Complete Movie\\nðŸ“Š Size: {video_size:.2f} MB"
    await client.send_file(channel, "video.mp4", caption=caption, supports_streaming=True)
    print("Video sent")
    
    await client.disconnect()
    print("Done!")

asyncio.run(main())
'
        
    - name: Clean
      run: |
        rm -f poster.jpg video.mp4
