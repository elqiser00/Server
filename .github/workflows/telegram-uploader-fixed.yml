# .github/workflows/telegram-uploader-fixed.yml

name: Telegram Movie Uploader - Final

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'ูุนุฑู ุงูููุงุฉ/ุงูุฌุฑูุจ (ID ุงูููุงุฉ)'
        required: true
        type: string
        default: '1548535280'
      content_name:
        description: 'ุงุณู ุงููููู'
        required: true
        type: string
        default: 'Truth & Treason 2025'
      image_url:
        description: 'ุฑุงุจุท ุตูุฑุฉ ุงูุบูุงู'
        required: true
        type: string
        default: 'https://img.downet.net/uploads/U8xQf.webp'
      video_url:
        description: 'ุฑุงุจุท ุงูููุฏูู (.mp4 ููุท)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.9'

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ๐ ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
      run: |
        echo "========================================="
        echo "๐ฌ  ุจุฏุก ุฑูุน ูููู ุฅูู Telegram"
        echo "========================================="
        echo "๐  ุงุณู ุงููููู: ${{ github.event.inputs.content_name }}"
        echo "๐ฅ  ุฅูู ุงูููุงุฉ: ${{ github.event.inputs.chat_id }}"
        echo "๐ผ๏ธ  ุตูุฑุฉ ุงูุบูุงู: ${{ github.event.inputs.image_url }}"
        echo "๐ฅ  ุฑุงุจุท ุงูููุฏูู: ${{ github.event.inputs.video_url }}"
        echo "โฐ  ุงูููุช: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================="
        
    - name: ๐ง ุชุซุจูุช ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ
      run: |
        echo "๐ง  ุฌุงุฑู ุชุซุจูุช ุงููุชุทูุจุงุช..."
        sudo apt-get update -y
        sudo apt-get install -y wget python3 python3-pip ffmpeg
        
        echo "โ  ุชู ุชุซุจูุช ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ"
        
    - name: ๐ ุชุซุจูุช Telethon
      run: |
        echo "๐  ุฌุงุฑู ุชุซุจูุช Telethon..."
        pip3 install telethon==1.34.0 --quiet
        echo "โ  ุชู ุชุซุจูุช Telethon"
        
    - name: ๐ ุฅูุดุงุก ุณูุฑุจุช ุงูุฑูุน ุงูููุงุฆู
      run: |
        cat > upload_final.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        import re
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        print("๐ ุจุฏุก ุณูุฑุจุช ุฑูุน ุงูุฃููุงู ุฅูู Telegram...")
        print("=" * 50)
        
        # ุจูุงูุงุช ูู Secrets
        try:
            API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
            API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
            SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
            
            # ุจูุงูุงุช ูู GitHub
            CHAT_ID = os.environ.get('CHAT_ID', '1548535280')
            CONTENT_NAME = os.environ.get('CONTENT_NAME', 'Truth & Treason 2025')
            IMAGE_URL = os.environ.get('IMAGE_URL', 'https://img.downet.net/uploads/U8xQf.webp')
            VIDEO_URL = os.environ.get('VIDEO_URL', '')
            
            print(f"โ ุชู ุชุญููู ุงูุจูุงูุงุช:")
            print(f"   ๐ฑ API_ID: {API_ID}")
            print(f"   ๐ API_HASH: {API_HASH[:10]}...")
            print(f"   ๐ SESSION: {SESSION_STRING[:15]}...")
            print(f"   ๐ข Chat ID: {CHAT_ID}")
            print(f"   ๐ฌ ุงููููู: {CONTENT_NAME}")
            print(f"   ๐ผ๏ธ  ุงูุตูุฑุฉ: {IMAGE_URL[:50]}...")
            print(f"   ๐ฅ  ุงูููุฏูู: {VIDEO_URL[:50]}...")
            print("=" * 50)
            
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: {e}")
            sys.exit(1)
        
        def log(message, level='INFO'):
            """ุชุณุฌูู ุงูุฑุณุงุฆู ูุน ุงูููุช"""
            from datetime import datetime
            timestamp = datetime.now().strftime('%H:%M:%S')
            print(f'[{timestamp}] [{level}] {message}', flush=True)
        
        def clean_filename(name):
            """ุชูุธูู ุงุณู ุงูููู ูู ุงูุฃุญุฑู ุบูุฑ ุงููุณููุญ ุจูุง"""
            # ุฅุฒุงูุฉ ุงูุฃุญุฑู ุบูุฑ ุงูุขููุฉ
            name = re.sub(r'[<>:"/\\|?*]', '', name)
            # ุงุณุชุจุฏุงู ุงููุณุงูุงุช ุงููุชุนุฏุฏุฉ
            name = re.sub(r'\s+', ' ', name)
            # ุชูููู ุงูุทูู ุฅุฐุง ูุงู ุทูููุงู
            if len(name) > 100:
                name = name[:100]
            return name.strip()
        
        def download_file(url, filename, max_retries=3):
            """ุชูุฒูู ููู ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ"""
            import time
            
            for attempt in range(max_retries):
                try:
                    log(f'โฌ๏ธ  ูุญุงููุฉ ุชูุฒูู {filename} ({attempt + 1}/{max_retries})')
                    
                    # ุฅูุดุงุก ุฃูุฑ wget
                    cmd = [
                        'wget',
                        '--no-check-certificate',  # ุชุฌุงูุฒ ูุดุงูู SSL
                        '-c',                      # ุงุณุชุฆูุงู ุงูุชูุฒูู
                        '--timeout=60',
                        '--tries=3',
                        '--waitretry=5',
                        '--retry-connrefused',
                        '--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                        '--show-progress',
                        '-O', filename,
                        url
                    ]
                    
                    # ุชูููุฐ ุงูุฃูุฑ
                    result = subprocess.run(cmd, capture_output=True, text=True)
                    
                    if result.returncode == 0:
                        if os.path.exists(filename):
                            size = os.path.getsize(filename)
                            if size > 0:
                                log(f'โ ุชู ุชูุฒูู {filename} ({size:,} ุจุงูุช)', 'SUCCESS')
                                return True
                            else:
                                log(f'โ๏ธ  ุงูููู ูุงุฑุบ: {filename}', 'WARNING')
                        else:
                            log(f'โ ุงูููู ุบูุฑ ููุฌูุฏ ุจุนุฏ ุงูุชูุฒูู', 'ERROR')
                    else:
                        log(f'โ ูุดู ุงูุชูุฒูู: {result.stderr[:100]}', 'ERROR')
                        
                except Exception as e:
                    log(f'โ ุฎุทุฃ ูู ุงูุชูุฒูู: {e}', 'ERROR')
                
                # ุงูุงูุชุธุงุฑ ูุจู ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                if attempt < max_retries - 1:
                    wait_time = (attempt + 1) * 5
                    log(f'โณ ุงูุชุธุงุฑ {wait_time} ุซุงููุฉ ูุจู ุฅุนุงุฏุฉ ุงููุญุงููุฉ...')
                    time.sleep(wait_time)
            
            return False
        
        async def upload_movie():
            """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ูุฑูุน ุงููููู"""
            log('=' * 50)
            log('๐ฌ ุจุฏุก ุนูููุฉ ุฑูุน ุงููููู')
            log('=' * 50)
            
            # ุชูุธูู ุงุณู ุงููููู
            clean_name = clean_filename(CONTENT_NAME)
            log(f'๐ ุงูุงุณู ุจุนุฏ ุงูุชูุธูู: {clean_name}')
            
            # ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
            if not all([API_ID, API_HASH, SESSION_STRING]):
                log('โ ุจูุงูุงุช Telegram ุบูุฑ ููุชููุฉ', 'ERROR')
                return False
            
            if not VIDEO_URL:
                log('โ ุฑุงุจุท ุงูููุฏูู ูุทููุจ', 'ERROR')
                return False
            
            # ุงูุชุญูู ูู ุตุญุฉ ุฑุงุจุท ุงูููุฏูู
            if not VIDEO_URL.lower().endswith('.mp4'):
                log('โ๏ธ  ุฑุงุจุท ุงูููุฏูู ูุง ููุชูู ุจู .mp4', 'WARNING')
                log('โ๏ธ  ูุฏ ูููู ููุงู ูุดุงูู ูู ุงูุฑูุน', 'WARNING')
            
            # ุฅูุดุงุก ุนููู Telegram
            client = None
            try:
                log('๐ ุฌุงุฑู ุงูุงุชุตุงู ุจู Telegram...')
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH
                )
                
                await client.connect()
                
                # ุงูุชุญูู ูู ุงูุงุชุตุงู
                me = await client.get_me()
                log(f'โ ูุชุตู ูู: {me.first_name} (@{me.username if me.username else "ูุง ููุฌุฏ"})', 'SUCCESS')
                
                # ุงูุชุญูู ูู ุงูููุงุฉ
                log(f'๐ ุฌุงุฑู ุงูุจุญุซ ุนู ุงูููุงุฉ {CHAT_ID}...')
                try:
                    chat_id_int = int(CHAT_ID)
                    entity = await client.get_entity(chat_id_int)
                    log(f'โ ุชู ุงูุนุซูุฑ ุนูู ุงูููุงุฉ: {entity.title}', 'SUCCESS')
                    log(f'   ๐ ููุน ุงูููุงุฉ: {"ููุงุฉ ุจุซ" if entity.broadcast else "ูุฌููุนุฉ"}')
                    
                    # ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
                    try:
                        permissions = await client.get_permissions(entity, me)
                        if permissions:
                            log('โ ูุฏูู ุตูุงุญูุงุช ูู ุงูููุงุฉ', 'SUCCESS')
                        else:
                            log('โ๏ธ  ูุฏ ูุง ุชููู ุนุถู ูู ุงูููุงุฉ', 'WARNING')
                    except:
                        log('โน๏ธ  ุฌุงุฑู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช...', 'INFO')
                        
                except ValueError:
                    log(f'๐ ุฌุงุฑู ุงูุจุญุซ ุนู ุงูููุงุฉ {CHAT_ID}...')
                    entity = await client.get_entity(CHAT_ID)
                    log(f'โ ุชู ุงูุนุซูุฑ ุนูู ุงูููุงุฉ: {entity.title}', 'SUCCESS')
                    
            except Exception as e:
                log(f'โ ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}', 'ERROR')
                log('๐ ุชุฃูุฏ ูู:')
                log('   1. ุตุญุฉ API_ID ู API_HASH')
                log('   2. ุตุญุฉ SESSION_STRING')
                log('   3. ุฅุถุงูุฉ ุงูุญุณุงุจ ููููุงุฉ')
                return False
            
            # ุนูููุฉ ุงูุฑูุน
            try:
                log('=' * 50)
                log('๐ค ุจุฏุก ุนูููุฉ ุงูุฑูุน')
                log('=' * 50)
                
                # 1. ุฑูุน ุงูุตูุฑุฉ
                log('๐ผ๏ธ  ุฌุงุฑู ุฑูุน ุตูุฑุฉ ุงูุบูุงู...')
                image_filename = f"{clean_name}_poster.jpg"
                
                if download_file(IMAGE_URL, image_filename):
                    log(f'๐ค ุฌุงุฑู ุฑูุน ุงูุตูุฑุฉ: {image_filename}')
                    
                    # ุฑูุน ุงูุตูุฑุฉ ูุน ูุงุจุดู
                    await client.send_file(
                        entity,
                        image_filename,
                        caption=f'๐ฌ **{CONTENT_NAME}**\n\n๐ค ุชู ุงูุฑูุน ุนุจุฑ GitHub Actions\nโฐ {os.environ.get("GITHUB_SHA", "")[:7]}'
                    )
                    log('โ ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ', 'SUCCESS')
                    
                    # ุญุฐู ุงูุตูุฑุฉ ุงููุคูุชุฉ
                    os.remove(image_filename)
                    log(f'๐๏ธ  ุชู ุญุฐู {image_filename}')
                else:
                    log('โ ูุดู ุชูุฒูู ุงูุตูุฑุฉ', 'ERROR')
                    # ุงููุชุงุจุนุฉ ุฑุบู ุฐูู
                
                # 2. ุฑูุน ุงูููุฏูู
                log('๐ฅ ุฌุงุฑู ุฑูุน ุงูููุฏูู...')
                video_filename = f"{clean_name}.mp4"
                
                if download_file(VIDEO_URL, video_filename):
                    file_size = os.path.getsize(video_filename)
                    size_mb = file_size / (1024 * 1024)
                    
                    log(f'๐ ุญุฌู ุงูููุฏูู: {size_mb:.2f} MB', 'INFO')
                    log(f'๐ค ุฌุงุฑู ุฑูุน ุงูููุฏูู...')
                    
                    # ุฑูุน ุงูููุฏูู ูุน ุชูุฏู
                    def upload_progress(current, total):
                        percent = (current / total) * 100
                        log(f'๐ ุชูุฏู ุงูุฑูุน: {percent:.1f}% ({current:,}/{total:,} ุจุงูุช)', 'INFO')
                    
                    # ุฑูุน ุงูููุฏูู
                    await client.send_file(
                        entity,
                        video_filename,
                        caption=f'๐ฅ **{CONTENT_NAME}**\n\n๐ ุงูุญุฌู: {size_mb:.2f} MB\nโ ุชู ุงูุฑูุน ุจูุฌุงุญ\n๐ GitHub Actions',
                        progress_callback=upload_progress
                    )
                    
                    log('โ ุชู ุฑูุน ุงูููุฏูู ุจูุฌุงุญ', 'SUCCESS')
                    
                    # ุญุฐู ุงูููุฏูู ุงููุคูุช
                    os.remove(video_filename)
                    log(f'๐๏ธ  ุชู ุญุฐู {video_filename}')
                else:
                    log('โ ูุดู ุชูุฒูู ุงูููุฏูู', 'ERROR')
                    return False
                
                log('=' * 50)
                log('๐ ุชู ุงูุชูุงู ุนูููุฉ ุงูุฑูุน ุจูุฌุงุญ!', 'SUCCESS')
                log('=' * 50)
                return True
                
            except Exception as e:
                log(f'โ ุฎุทุฃ ุฃุซูุงุก ุงูุฑูุน: {e}', 'ERROR')
                return False
                
            finally:
                # ูุทุน ุงูุงุชุตุงู
                if client:
                    await client.disconnect()
                    log('๐ ุชู ูุทุน ุงูุงุชุตุงู ุจู Telegram')
        
        async def main():
            """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
            try:
                success = await upload_movie()
                if success:
                    print("\n" + "=" * 50)
                    print("โ **ุชูุช ุงูุนูููุฉ ุจูุฌุงุญ!**")
                    print("=" * 50)
                    sys.exit(0)
                else:
                    print("\n" + "=" * 50)
                    print("โ **ูุดูุช ุงูุนูููุฉ**")
                    print("=" * 50)
                    sys.exit(1)
            except KeyboardInterrupt:
                log("โน๏ธ  ุชู ุฅููุงู ุงูุนูููุฉ ูุฏููุงู", "WARNING")
                sys.exit(1)
            except Exception as e:
                log(f"๐ฅ ุฎุทุฃ ุบูุฑ ูุชููุน: {e}", "ERROR")
                sys.exit(1)
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "๐ ุชู ุฅูุดุงุก ุณูุฑุจุช ุงูุฑูุน ุงูููุงุฆู"
        echo "๐ ุฌุงุฑู ูุญุต ุงูุณูุฑุจุช..."
        python3 -m py_compile upload_final.py
        echo "โ ุงูุณูุฑุจุช ุตุญูุญ ุงููุญู"
        
    - name: โก ุชุดุบูู ุณูุฑุจุช ุงูุฑูุน
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        echo "โก ุชุดุบูู ุณูุฑุจุช ุฑูุน ุงูุฃููุงู..."
        echo "=========================================="
        python3 upload_final.py
        echo "=========================================="
        
    - name: ๐ ุนุฑุถ ูุชูุฌุฉ ุงูุชูููุฐ
      if: always()
      run: |
        echo ""
        echo "๐ ========================================="
        echo "๐ ูุชูุฌุฉ ุชูููุฐ ุงูู Action"
        echo "๐ ========================================="
        echo "๐ ููุช ุงูุงูุชูุงุก: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "๐ ุงุณู ุงููููู: ${{ github.event.inputs.content_name }}"
        echo "๐ข ID ุงูููุงุฉ: ${{ github.event.inputs.chat_id }}"
        echo "๐ ุฑุงุจุท ุงูููุฏูู: ${{ github.event.inputs.video_url[:50] }}..."
        echo "๐ ุงูุญุงูุฉ ุงูููุงุฆูุฉ: ${{ job.status }}"
        echo "๐ ========================================="
