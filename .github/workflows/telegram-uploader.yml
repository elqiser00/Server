# .github/workflows/telegram-streaming-upload.yml
name: ğŸ¬ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„

on:
  workflow_dispatch:
    inputs:
      invite_link:
        description: 'Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        default: 'https://t.me/+VvLRMffUCXNlNjRk'
        type: string
      movie_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'Truth & Treason 2025'
        type: string
      poster_url:
        description: 'Ø±Ø§Ø¨Ø· Ø¨ÙˆØ³ØªØ± Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'https://img.downet.net/uploads/U8xQf.webp'
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (.mp4)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 Ø³Ø§Ø¹Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    
    steps:
    - name: ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      run: |
        echo "========================================"
        echo "ğŸ¬ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ ÙƒÙ…Ø´ØºÙ„ ÙÙŠ Telegram"
        echo "========================================"
        echo "ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨: @ELQISEER"
        echo "ğŸ“¢ Ø§Ù„Ù‚Ù†Ø§Ø©: Super Movie"
        echo "ğŸ¬ Ø§Ù„ÙÙŠÙ„Ù…: ${{ github.event.inputs.movie_name }}"
        echo "âš¡ Ø³ÙŠØ´ØªØºÙ„ ÙƒÙ…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±"
        echo "========================================"
    
    - name: âš™ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget ffmpeg
        pip3 install telethon==1.34.0 --quiet
        
    - name: ğŸ“ Ø³ÙƒØ±Ø¨Øª Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØªØ¯ÙÙ‚
      run: |
        cat > streaming_upload.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        import time
        
        print("ğŸš€ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„ Ù…Ø¨Ø§Ø´Ø±")
        print("=" * 50)
        
        # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
        
        INVITE_LINK = os.environ.get('INVITE_LINK', 'https://t.me/+VvLRMffUCXNlNjRk')
        MOVIE_NAME = os.environ.get('MOVIE_NAME', 'Truth & Treason 2025')
        POSTER_URL = os.environ.get('POSTER_URL', '')
        VIDEO_URL = os.environ.get('VIDEO_URL', '')
        
        print(f"ğŸ¬ Ø§Ù„ÙÙŠÙ„Ù…: {MOVIE_NAME}")
        print(f"ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨: @ELQISEER (Ø­Ø³Ø§Ø¨ Ø´Ø®ØµÙŠ)")
        print(f"ğŸ“¢ Ø§Ù„Ù‚Ù†Ø§Ø©: {INVITE_LINK}")
        print("=" * 50)
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        async def optimize_video_for_streaming(input_file, output_file):
            """ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Telegram"""
            print(f"\nâš™ï¸  ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...")
            
            cmd = [
                'ffmpeg',
                '-i', input_file,
                '-c:v', 'libx264',
                '-preset', 'fast',
                '-crf', '23',
                '-c:a', 'aac',
                '-b:a', '128k',
                '-movflags', '+faststart',
                '-f', 'mp4',
                output_file
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                original_size = os.path.getsize(input_file)
                optimized_size = os.path.getsize(output_file)
                print(f"âœ… ØªÙ… Ø§Ù„ØªØ­Ø³ÙŠÙ†: {original_size/(1024*1024):.1f}MB â†’ {optimized_size/(1024*1024):.1f}MB")
                return True
            else:
                print(f"âš ï¸  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ: {result.stderr}")
                return False
        
        async def main():
            print("\nğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram...")
            
            client = None
            try:
                # Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH,
                    connection_retries=10,
                    request_retries=5,
                    flood_sleep_threshold=60
                )
                
                await client.connect()
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
                me = await client.get_me()
                print(f"âœ… Ù…ØªØµÙ„ ÙƒÙ€: {me.first_name} (@{me.username})")
                
                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©
                print(f"\nğŸ“¢ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©...")
                channel = await client.get_entity(INVITE_LINK)
                print(f"âœ… Ø§Ù„Ù‚Ù†Ø§Ø©: {channel.title}")
                
                # 1. Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ³ØªØ± Ø£ÙˆÙ„Ø§Ù‹
                print(f"\nğŸ“¸ Ø±ÙØ¹ Ø¨ÙˆØ³ØªØ± Ø§Ù„ÙÙŠÙ„Ù…...")
                subprocess.run(['wget', '-q', '-O', 'poster.jpg', POSTER_URL], check=True)
                
                await client.send_file(
                    channel,
                    'poster.jpg',
                    caption=f'ğŸ¬ **{MOVIE_NAME}**\nğŸ“¸ Ø¨ÙˆØ³ØªØ± Ø§Ù„ÙÙŠÙ„Ù…\n\nâ³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...'
                )
                print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ³ØªØ±")
                
                # 2. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…Ù„
                print(f"\nâ¬‡ï¸  ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…Ù„...")
                print("â³ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 10-15 Ø¯Ù‚ÙŠÙ‚Ø©...")
                
                start_download = time.time()
                result = subprocess.run([
                    'wget',
                    '--no-check-certificate',
                    '-c',
                    '--timeout=180',
                    '--tries=5',
                    '--show-progress',
                    '-O', 'original_video.mp4',
                    VIDEO_URL
                ], capture_output=True, text=True)
                
                if result.returncode != 0:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {result.stderr}")
                    return False
                
                download_time = time.time() - start_download
                file_size = os.path.getsize('original_video.mp4')
                print(f"âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {file_size/(1024*1024):.1f} MB")
                print(f"â±ï¸  ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {download_time/60:.1f} Ø¯Ù‚ÙŠÙ‚Ø©")
                
                # 3. ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                optimized = await optimize_video_for_streaming('original_video.mp4', 'streaming_video.mp4')
                
                # 4. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                print(f"\nğŸ¥ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„)...")
                print("âš ï¸  Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 30-90 Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù€ 782 MB")
                print("ğŸ’¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Telegram")
                
                upload_start = time.time()
                last_update = 0
                
                def progress_callback(current, total):
                    nonlocal last_update
                    now = time.time()
                    
                    # ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù† Ø£Ùˆ ÙƒÙ„ 10%
                    if now - last_update > 10 or (current/total)*100 - last_update > 10:
                        percent = (current / total) * 100
                        elapsed = now - upload_start
                        speed = current / elapsed / (1024 * 1024)
                        
                        print(f"ğŸ“¤ Ø±ÙØ¹: {percent:.1f}% | "
                              f"{current/(1024*1024):.1f}/{total/(1024*1024):.1f} MB | "
                              f"{speed:.2f} MB/Ø« | "
                              f"{elapsed/60:.1f} Ø¯Ù‚ÙŠÙ‚Ø©")
                        last_update = (current/total)*100
                
                # â­â­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‡Ù…Ø© Ù„Ø¬Ø¹Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„ â­â­
                video_to_upload = 'streaming_video.mp4' if optimized else 'original_video.mp4'
                
                await client.send_file(
                    channel,
                    video_to_upload,
                    caption=f'ğŸ¥ **{MOVIE_NAME}**\n'
                           f'ğŸ“Š Ø§Ù„Ø­Ø¬Ù…: {os.path.getsize(video_to_upload)/(1024*1024):.1f} MB\n'
                           f'âœ… Ø§Ù„ÙÙŠÙ„Ù… ÙƒØ§Ù…Ù„ - ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„\n'
                           f'ğŸ‘¤ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© @ELQISEER',
                    progress_callback=progress_callback,
                    # â­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¬Ø¹Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„ â­
                    supports_streaming=True,
                    attributes=[
                        {
                            '_': 'DocumentAttributeVideo',
                            'duration': 0,  # Ø³ÙŠÙ…Ù„Ø£Ù‡Ø§ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            'w': 0,         # Ø³ÙŠÙ…Ù„Ø£Ù‡Ø§ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            'h': 0,         # Ø³ÙŠÙ…Ù„Ø£Ù‡Ø§ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            'round_message': False,
                            'supports_streaming': True  # â­ Ù‡Ø°Ø§ Ù…Ù‡Ù… Ù„Ù„Ù…Ø´ØºÙ„ â­
                        }
                    ]
                )
                
                upload_time = time.time() - upload_start
                print(f"\nâœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!")
                print(f"ğŸ‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Telegram")
                print(f"â±ï¸  ÙˆÙ‚Øª Ø§Ù„Ø±ÙØ¹: {upload_time/60:.1f} Ø¯Ù‚ÙŠÙ‚Ø©")
                
                return True
                
            except Exception as e:
                print(f"\nâŒ Ø®Ø·Ø£: {type(e).__name__}")
                print(f"ğŸ“ {str(e)[:200]}")
                return False
                
            finally:
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                for file in ['poster.jpg', 'original_video.mp4', 'streaming_video.mp4']:
                    if os.path.exists(file):
                        os.remove(file)
                        print(f"ğŸ—‘ï¸  ØªÙ… Ø­Ø°Ù: {file}")
                
                if client:
                    await client.disconnect()
                    print("\nğŸ”’ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
        
        if __name__ == "__main__":
            success = asyncio.run(main())
            sys.exit(0 if success else 1)
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±"
        
    - name: âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        INVITE_LINK: ${{ github.event.inputs.invite_link }}
        MOVIE_NAME: ${{ github.event.inputs.movie_name }}
        POSTER_URL: ${{ github.event.inputs.poster_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ Ø¨Ø¯Ø¡ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ ÙƒÙ…Ø´ØºÙ„ Ù…Ø¨Ø§Ø´Ø±..."
        echo "========================================"
        python3 streaming_upload.py
        echo "========================================"
        
    - name: ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo "ğŸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª!"
        echo "ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date '+%H:%M:%S')"
        echo "ğŸ“Š Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø±ÙØ¹ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø´ØºÙ„ ÙÙŠ Telegram"
