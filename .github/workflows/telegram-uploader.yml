# .github/workflows/telegram-fast-upload.yml
name: Fast Upload via Personal Account

on:
  workflow_dispatch:
    inputs:
      invite_link:
        description: 'Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        default: 'https://t.me/+VvLRMffUCXNlNjRk'
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'Truth & Treason 2025'
        type: string
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        default: 'https://img.downet.net/uploads/U8xQf.webp'
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ù‡Ù„Ø©
    
    steps:
    - name: âš¡ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø±ÙŠØ¹
      run: |
        echo "âš¡ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø³Ø±ÙŠØ¹Ø©..."
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget
        pip3 install telethon==1.34.0 --quiet
        
    - name: ðŸ“ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      run: |
        cat > direct_upload.py << 'EOF'
        import asyncio
        import os
        import sys
        import aiohttp
        import time
        
        print("âš¡ Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ")
        print("=" * 50)
        
        # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
        
        INVITE_LINK = os.environ.get('INVITE_LINK', 'https://t.me/+VvLRMffUCXNlNjRk')
        CONTENT_NAME = os.environ.get('CONTENT_NAME', 'Truth & Treason 2025')
        IMAGE_URL = os.environ.get('IMAGE_URL', '')
        VIDEO_URL = os.environ.get('VIDEO_URL', '')
        
        print(f"ðŸŽ¬ Ø§Ù„ÙÙŠÙ„Ù…: {CONTENT_NAME}")
        print(f"ðŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨: @ELQISEER")
        print("=" * 50)
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        async def download_file(url, filename):
            """ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… aiohttp (Ø£Ø³Ø±Ø¹)"""
            async with aiohttp.ClientSession() as session:
                async with session.get(url) as response:
                    with open(filename, 'wb') as f:
                        while True:
                            chunk = await response.content.read(8192)
                            if not chunk:
                                break
                            f.write(chunk)
        
        async def upload_large_video(client, channel, video_path, caption):
            """Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨ÙŠØ± Ø¨Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø­Ø³Ù†Ø©"""
            print(f"ðŸŽ¥ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {os.path.getsize(video_path)/(1024*1024):.1f} MB")
            
            # Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø±ÙØ¹
            return await client.send_file(
                channel,
                video_path,
                caption=caption,
                # â­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø³Ø±Ø¹Ø© â­
                supports_streaming=True,
                # â­ ØªÙ‚Ù„ÙŠÙ„ Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ±Ù…ÙŠØ² Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø±ÙØ¹ â­
                attributes=[
                    {
                        '_': 'DocumentAttributeVideo',
                        'duration': 0,
                        'w': 0,
                        'h': 0,
                        'round_message': False,
                        'supports_streaming': True
                    }
                ]
            )
        
        async def main():
            client = None
            try:
                # â­ Ø§ØªØµØ§Ù„ Ø³Ø±ÙŠØ¹ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø© â­
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH,
                    # â­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© â­
                    connection_retries=10,
                    request_retries=10,
                    flood_sleep_threshold=120,
                    auto_reconnect=True
                )
                
                print("ðŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram...")
                await client.connect()
                
                if not await client.is_user_authorized():
                    print("âŒ Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©!")
                    return False
                
                me = await client.get_me()
                print(f"âœ… Ù…ØªØµÙ„ ÙƒÙ€: @{me.username}")
                
                # Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©
                print("ðŸ“¢ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©...")
                channel = await client.get_entity(INVITE_LINK)
                print(f"âœ… Ø§Ù„Ù‚Ù†Ø§Ø©: {channel.title}")
                
                # 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ø³Ø±ÙŠØ¹Ø©)
                print("\nðŸ–¼ï¸ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù...")
                await download_file(IMAGE_URL, 'poster.jpg')
                
                await client.send_file(
                    channel,
                    'poster.jpg',
                    caption=f'ðŸŽ¬ {CONTENT_NAME} - ðŸ“¸ Ø¨ÙˆØ³ØªØ±'
                )
                print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©")
                
                # 2. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print("\nâ¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                start_download = time.time()
                await download_file(VIDEO_URL, 'movie.mp4')
                
                download_time = time.time() - start_download
                file_size = os.path.getsize('movie.mp4')
                print(f"âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {file_size/(1024*1024):.1f} MB")
                print(f"â±ï¸  ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {download_time:.1f} Ø«Ø§Ù†ÙŠØ©")
                print(f"ðŸš€ Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {file_size/download_time/(1024*1024):.2f} MB/Ø«")
                
                # 3. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print("\nðŸŽ¥ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Telegram...")
                print("âš ï¸  Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 20-40 Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù€ 782 MB")
                print("ðŸ’¡ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...")
                
                upload_start = time.time()
                
                # â­ Ø§Ø³ØªØ®Ø¯Ø§Ù… upload_large_video Ù„Ù„Ø³Ø±Ø¹Ø© â­
                await upload_large_video(
                    client,
                    channel,
                    'movie.mp4',
                    f'ðŸŽ¥ {CONTENT_NAME}\n'
                    f'ðŸ“Š Ø§Ù„Ø­Ø¬Ù…: {file_size/(1024*1024):.1f} MB\n'
                    f'âœ… Ø§Ù„ÙÙŠÙ„Ù… ÙƒØ§Ù…Ù„\n'
                    f'âš¡ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± @ELQISEER'
                )
                
                upload_time = time.time() - upload_start
                print(f"\nâœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!")
                print(f"â±ï¸  ÙˆÙ‚Øª Ø§Ù„Ø±ÙØ¹: {upload_time/60:.1f} Ø¯Ù‚ÙŠÙ‚Ø©")
                print(f"ðŸš€ Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙØ¹: {file_size/upload_time/(1024*1024):.2f} MB/Ø«")
                
                return True
                
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£: {type(e).__name__}: {str(e)[:200]}")
                return False
            finally:
                # ØªÙ†Ø¸ÙŠÙ
                for file in ['poster.jpg', 'movie.mp4']:
                    if os.path.exists(file):
                        os.remove(file)
                
                if client:
                    await client.disconnect()
                    print("\nðŸ”’ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
        
        # â­ Ø²ÙŠØ§Ø¯Ø© Ù…Ù‡Ù„Ø© asyncio â­
        if __name__ == "__main__":
            asyncio.run(main(), debug=True)
        EOF
        
    - name: âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        INVITE_LINK: ${{ github.event.inputs.invite_link }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± @ELQISEER..."
        echo "========================================"
        python3 direct_upload.py
        echo "========================================"
        
    - name: ðŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø±ÙØ¹
      if: always()
      run: |
        echo "â° ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: $(date)"
        echo "ðŸ“ˆ Ø§Ù„Ø­Ø§Ù„Ø©: ${{ job.status }}"
