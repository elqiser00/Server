# .github/workflows/telegram-uploader.yml
name: Upload Movie - Fixed

on:
  workflow_dispatch:
    inputs:
      invite_link:
        description: 'Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        default: 'https://t.me/+VvLRMffUCXNlNjRk'
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'Truth & Treason 2025'
        type: string
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        default: 'https://img.downet.net/uploads/U8xQf.webp'
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: âš™ï¸ ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget
        pip3 install telethon aiohttp --quiet
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª"
        
    - name: ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¹Ù…Ù„
      run: |
        cat > upload_final.py << 'EOF'
        import asyncio
        import os
        import sys
        import time
        
        print("ğŸš€ Ø±ÙØ¹ ÙÙŠÙ„Ù… Ø¹Ø¨Ø± @ELQISEER")
        print("=" * 50)
        
        # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
        
        INVITE_LINK = os.environ.get('INVITE_LINK', 'https://t.me/+VvLRMffUCXNlNjRk')
        CONTENT_NAME = os.environ.get('CONTENT_NAME', 'Truth & Treason 2025')
        IMAGE_URL = os.environ.get('IMAGE_URL', '')
        VIDEO_URL = os.environ.get('VIDEO_URL', '')
        
        print(f"ğŸ¬ Ø§Ù„ÙÙŠÙ„Ù…: {CONTENT_NAME}")
        print(f"ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨: @ELQISEER")
        print("=" * 50)
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        async def main():
            print("\nğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram...")
            
            client = None
            try:
                # Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ· ÙˆØ³Ø±ÙŠØ¹
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH
                )
                
                await client.connect()
                
                if not await client.is_user_authorized():
                    print("âŒ Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©!")
                    print("ğŸ”‘ ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ SESSION_STRING Ø¬Ø¯ÙŠØ¯Ø©")
                    return False
                
                me = await client.get_me()
                print(f"âœ… Ù…ØªØµÙ„ ÙƒÙ€: {me.first_name} (@{me.username})")
                
                # Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©
                print("\nğŸ“¢ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©...")
                channel = await client.get_entity(INVITE_LINK)
                print(f"âœ… Ø§Ù„Ù‚Ù†Ø§Ø©: {channel.title}")
                
                # â­ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„ÙŠ)
                print("\nğŸ“¸ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...")
                
                # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… wget
                import subprocess
                subprocess.run(['wget', '-q', '-O', 'poster.jpg', IMAGE_URL], check=True)
                
                await client.send_file(
                    channel,
                    'poster.jpg',
                    caption=f'ğŸ¬ **{CONTENT_NAME}**\nğŸ“¸ Ø¨ÙˆØ³ØªØ± Ø§Ù„ÙÙŠÙ„Ù…'
                )
                print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©")
                
                # â­ Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print("\nâ¬‡ï¸  ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                print("â³ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 5-10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù€ 782 MB")
                
                download_start = time.time()
                result = subprocess.run([
                    'wget',
                    '--no-check-certificate',
                    '-c',
                    '--timeout=60',
                    '--tries=3',
                    '--show-progress',
                    '-O', 'movie.mp4',
                    VIDEO_URL
                ], capture_output=True, text=True)
                
                if result.returncode != 0:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {result.stderr}")
                    return False
                
                download_time = time.time() - download_start
                file_size = os.path.getsize('movie.mp4')
                print(f"âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {file_size/(1024*1024):.1f} MB")
                print(f"â±ï¸  ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {download_time:.1f} Ø«Ø§Ù†ÙŠØ©")
                
                # â­ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print("\nğŸ¥ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Telegram...")
                print("âš ï¸  Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 30-60 Ø¯Ù‚ÙŠÙ‚Ø©")
                print("ğŸ’¡ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆÙ„Ø§ ØªØºÙ„Ù‚ Ø§Ù„ØµÙØ­Ø©")
                
                upload_start = time.time()
                last_progress = 0
                
                def progress_callback(current, total):
                    nonlocal last_progress
                    percent = (current / total) * 100
                    
                    # ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5% ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥ÙØ±Ø§Ø· ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                    if int(percent) // 5 > last_progress // 5:
                        elapsed = time.time() - upload_start
                        speed = current / elapsed / (1024 * 1024)  # MB/s
                        
                        print(f"ğŸ“¤ Ø±ÙØ¹: {percent:.1f}% | "
                              f"{current/(1024*1024):.1f} MB | "
                              f"{speed:.2f} MB/Ø« | "
                              f"{elapsed/60:.1f} Ø¯Ù‚ÙŠÙ‚Ø©")
                        last_progress = int(percent)
                
                # Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                await client.send_file(
                    channel,
                    'movie.mp4',
                    caption=f'ğŸ¥ **{CONTENT_NAME}**\n'
                           f'ğŸ“Š Ø§Ù„Ø­Ø¬Ù…: {file_size/(1024*1024):.1f} MB\n'
                           f'âœ… Ø§Ù„ÙÙŠÙ„Ù… ÙƒØ§Ù…Ù„\n'
                           f'ğŸ‘¤ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© @ELQISEER',
                    progress_callback=progress_callback,
                    supports_streaming=True
                )
                
                upload_time = time.time() - upload_start
                print(f"\nâœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!")
                print(f"ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø±ÙØ¹ ÙÙŠ {upload_time/60:.1f} Ø¯Ù‚ÙŠÙ‚Ø©")
                print(f"ğŸš€ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©: {file_size/upload_time/(1024*1024):.2f} MB/Ø«")
                
                return True
                
            except Exception as e:
                print(f"\nâŒ Ø®Ø·Ø£: {type(e).__name__}")
                print(f"ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {str(e)[:200]}")
                
                # Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ù…ÙØµÙ„
                import traceback
                traceback.print_exc()
                
                return False
                
            finally:
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                for file in ['poster.jpg', 'movie.mp4']:
                    if os.path.exists(file):
                        os.remove(file)
                        print(f"ğŸ—‘ï¸  ØªÙ… Ø­Ø°Ù {file}")
                
                if client:
                    await client.disconnect()
                    print("\nğŸ”’ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        if __name__ == "__main__":
            success = asyncio.run(main())
            sys.exit(0 if success else 1)
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ±Ø¨Øª"
        
    - name: âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        INVITE_LINK: ${{ github.event.inputs.invite_link }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹..."
        echo "========================================"
        python3 upload_final.py
        echo "========================================"
        
    - name: ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      if: always()
      run: |
        echo "â° ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: $(date '+%H:%M:%S')"
        echo "ğŸ Ø§Ù„Ø­Ø§Ù„Ø©: ${{ job.status }}"
        echo "========================================"
