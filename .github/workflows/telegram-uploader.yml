# .github/workflows/telegram-uploader.yml
name: Upload Movie with Side-by-Side

on:
  workflow_dispatch:
    inputs:
      invite_link:
        description: 'Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        default: 'https://t.me/+VvLRMffUCXNlNjRk'
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'Truth & Treason 2025'
        type: string
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        default: 'https://img.downet.net/uploads/U8xQf.webp'
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø³ØªØ±ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹
      run: |
        echo "========================================"
        echo "ğŸ¬ Ø±ÙØ¹ ÙÙŠÙ„Ù… Ù…Ø¹ Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ"
        echo "========================================"
        echo "ğŸ“¸ Ø§Ù„ØµÙˆØ±Ø©: Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±"
        echo "ğŸ¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†"
        echo "ğŸ¬ Ø§Ù„ÙÙŠÙ„Ù…: ${{ github.event.inputs.content_name }}"
        echo "========================================"
    
    - name: âš™ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Telethon
      run: |
        pip3 install telethon --quiet
        
    - name: ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø°ÙƒÙŠ
      run: |
        cat > upload_side_by_side.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        
        print("ğŸš€ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ù…Ø¹ Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ")
        print("=" * 50)
        
        # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
        
        INVITE_LINK = os.environ.get('INVITE_LINK', 'https://t.me/+VvLRMffUCXNlNjRk')
        CONTENT_NAME = os.environ.get('CONTENT_NAME', 'ÙÙŠÙ„Ù…')
        IMAGE_URL = os.environ.get('IMAGE_URL', '')
        VIDEO_URL = os.environ.get('VIDEO_URL', '')
        
        print(f"âš™ï¸  Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:")
        print(f"   ğŸ¬ Ø§Ù„ÙÙŠÙ„Ù…: {CONTENT_NAME}")
        print(f"   ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©: {INVITE_LINK}")
        print("=" * 50)
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        async def main():
            print("\nğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...")
            
            client = None
            try:
                # Ø§Ù„Ø§ØªØµØ§Ù„
                client = TelegramClient(StringSession(SESSION_STRING), API_ID, API_HASH)
                await client.connect()
                
                if not await client.is_user_authorized():
                    print("âŒ Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©!")
                    return
                
                me = await client.get_me()
                print(f"âœ… Ù…ØªØµÙ„: @{me.username}")
                
                # Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©
                print(f"\nğŸ”— Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©...")
                try:
                    channel = await client.get_entity(INVITE_LINK)
                    print(f"âœ… Ø§Ù„Ù‚Ù†Ø§Ø©: {channel.title}")
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©: {e}")
                    return
                
                # â­ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ© â­
                print(f"\nğŸ‘¥ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ©...")
                try:
                    group = await client.create_group(
                        title=f"ğŸ¬ {CONTENT_NAME}",
                        users=[me.id]  # Ø£Ø¶Ù Ù†ÙØ³Ùƒ ÙÙ‚Ø·
                    )
                    print(f"âœ… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: {group.title}")
                    
                    # â­ Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â­
                    print(f"\nğŸ“¸ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©...")
                    
                    # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    subprocess.run([
                        'wget', '-q', '--show-progress',
                        '-O', 'poster.jpg',
                        IMAGE_URL
                    ], check=True)
                    
                    # Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                    await client.send_file(
                        group.id,
                        'poster.jpg',
                        caption=f'ğŸ¬ **{CONTENT_NAME}**\nğŸ“¸ Ø¨ÙˆØ³ØªØ± Ø§Ù„ÙÙŠÙ„Ù…'
                    )
                    print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©")
                    
                    # â­ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â­
                    print(f"\nğŸ¥ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©...")
                    print("â¬‡ï¸  Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                    
                    # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    subprocess.run([
                        'wget',
                        '--no-check-certificate',
                        '-c',
                        '--timeout=300',
                        '--tries=5',
                        '--show-progress',
                        '-O', 'movie.mp4',
                        VIDEO_URL
                    ], check=True)
                    
                    # Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
                    def progress_callback(current, total):
                        percent = (current / total) * 100
                        if int(percent) % 10 == 0:
                            print(f"ğŸ“¤ Ø±ÙØ¹: {percent:.1f}%")
                    
                    await client.send_file(
                        group.id,
                        'movie.mp4',
                        caption=f'ğŸ¥ **{CONTENT_NAME}**\nâœ… Ø§Ù„ÙÙŠÙ„Ù… ÙƒØ§Ù…Ù„',
                        progress_callback=progress_callback
                    )
                    print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
                    
                    # â­ Ø§Ù„Ø®Ø·ÙˆØ© 4: Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù‚Ù†Ø§Ø© â­
                    print(f"\nğŸ“¤ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù‚Ù†Ø§Ø©...")
                    
                    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
                    messages = await client.get_messages(group.id, limit=10)
                    
                    # Ù†Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù‚Ù†Ø§Ø©
                    for msg in messages:
                        if msg.photo:
                            await client.send_file(
                                channel.id,
                                msg.photo,
                                caption=msg.message
                            )
                            print("âœ… Ù†Ù‚Ù„Øª Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù‚Ù†Ø§Ø©")
                            break
                    
                    # Ù†Ù‚Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù‚Ù†Ø§Ø©
                    for msg in messages:
                        if msg.video or (msg.document and msg.document.mime_type == 'video/mp4'):
                            await client.send_file(
                                channel.id,
                                msg.video or msg.document,
                                caption=msg.message
                            )
                            print("âœ… Ù†Ù‚Ù„Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù‚Ù†Ø§Ø©")
                            break
                    
                    # â­ Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â­
                    await client.delete_dialog(group.id)
                    print("ğŸ—‘ï¸  ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©")
                    
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£: {e}")
                    return
                
                print("\n" + "=" * 50)
                print("ğŸ‰ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!")
                print("ğŸ“¸ Ø§Ù„ØµÙˆØ±Ø©: Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±")
                print("ğŸ¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†")
                print("=" * 50)
                return True
                
            except Exception as e:
                print(f"ğŸ’¥ Ø®Ø·Ø£: {e}")
                return False
                
            finally:
                # ØªÙ†Ø¸ÙŠÙ
                for file in ['poster.jpg', 'movie.mp4']:
                    if os.path.exists(file):
                        os.remove(file)
                
                if client:
                    await client.disconnect()
                    print("\nğŸ”’ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ±Ø¨Øª"
        
    - name: âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        INVITE_LINK: ${{ github.event.inputs.invite_link }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹..."
        echo "========================================"
        python3 upload_side_by_side.py
        echo "========================================"
        
    - name: ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo "âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª: $(date)"
