# .github/workflows/telegram-uploader.yml
name: Upload to Private Channel

on:
  workflow_dispatch:
    inputs:
      # â­ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ID â­
      invite_link:
        description: 'Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø§Ù„Ù‚Ù†Ø§Ø© (Invite Link)'
        required: true
        default: 'https://t.me/+VvLRMffUCXNlNjRk'
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'Truth & Treason 2025'
        type: string
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        default: 'https://img.downet.net/uploads/U8xQf.webp'
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (.mp4)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø®Ø§ØµØ©
      run: |
        echo "========================================"
        echo "ðŸŽ¬ Ø±ÙØ¹ ÙÙŠÙ„Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø®Ø§ØµØ©"
        echo "========================================"
        echo "ðŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©: ${{ github.event.inputs.invite_link }}"
        echo "ðŸŽ¬ Ø§Ù„ÙÙŠÙ„Ù…: ${{ github.event.inputs.content_name }}"
        echo "========================================"
    
    - name: âš™ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget
        pip3 install telethon --quiet
        
    - name: ðŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
      run: |
        cat > upload_with_invite.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        
        print("ðŸš€ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø®Ø§ØµØ© Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©")
        print("=" * 50)
        
        # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Secrets
        API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
        
        # Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø±ÙØ¹
        INVITE_LINK = os.environ.get('INVITE_LINK', 'https://t.me/+VvLRMffUCXNlNjRk')
        CONTENT_NAME = os.environ.get('CONTENT_NAME', 'ÙÙŠÙ„Ù…')
        IMAGE_URL = os.environ.get('IMAGE_URL', '')
        VIDEO_URL = os.environ.get('VIDEO_URL', '')
        
        print(f"âš™ï¸  Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:")
        print(f"   ðŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©: {INVITE_LINK}")
        print(f"   ðŸŽ¬ Ø§Ù„ÙÙŠÙ„Ù…: {CONTENT_NAME}")
        print("=" * 50)
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        async def main():
            print("\nðŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram...")
            
            client = None
            try:
                # 1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH
                )
                
                await client.connect()
                
                # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                if not await client.is_user_authorized():
                    print("âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡!")
                    print("ðŸ“± ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ SESSION_STRING Ø¬Ø¯ÙŠØ¯Ø©")
                    return
                
                me = await client.get_me()
                print(f"âœ… Ù…ØµØ§Ø¯Ù‚Ø© Ù†Ø§Ø¬Ø­Ø©: {me.first_name} (@{me.username})")
                
                # 3. â­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© â­
                print(f"\nðŸ”— Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·...")
                try:
                    # Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø© Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
                    entity = await client.get_entity(INVITE_LINK)
                    print(f"âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©: {entity.title}")
                    
                    # ØªØ£ÙƒØ¯ Ø£Ù†Ù†Ø§ Ø§Ù†Ø¶Ù…Ù…Ù†Ø§ Ù„Ù„Ù‚Ù†Ø§Ø©
                    if not await client.get_participants(entity, limit=1):
                        print("âš ï¸  Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©!")
                        print("ðŸ”‘ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† @ELQISEER Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©")
                        return
                        
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©: {e}")
                    print("\nðŸ’¡ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:")
                    print("   1. ØªØ£ÙƒØ¯ Ø£Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© ØµØ­ÙŠØ­: https://t.me/+VvLRMffUCXNlNjRk")
                    print("   2. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ @ELQISEER Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©")
                    print("   3. Ø¬Ø¯Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡")
                    return
                
                # 4. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                print(f"\nðŸ–¼ï¸  Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù...")
                try:
                    # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    subprocess.run([
                        'wget', 
                        '--no-check-certificate',
                        '-q',
                        '--show-progress',
                        '-O', 'poster.jpg',
                        IMAGE_URL
                    ], check=True, timeout=30)
                    
                    # Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                    await client.send_file(
                        entity,
                        'poster.jpg',
                        caption=f'ðŸŽ¬ {CONTENT_NAME}\nðŸ“¸ Poster'
                    )
                    print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©")
                    
                    # ØªÙ†Ø¸ÙŠÙ
                    if os.path.exists('poster.jpg'):
                        os.remove('poster.jpg')
                        
                except Exception as e:
                    print(f"âš ï¸  Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: {e}")
                    # Ù†Ø³ØªÙ…Ø± Ø±ØºÙ… Ø°Ù„Ùƒ
                
                # 5. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print(f"\nðŸŽ¥ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                try:
                    # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    print("â¬‡ï¸  Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                    subprocess.run([
                        'wget',
                        '--no-check-certificate',
                        '-c',
                        '--timeout=60',
                        '--tries=3',
                        '-O', 'movie.mp4',
                        VIDEO_URL
                    ], check=True, timeout=300)
                    
                    # Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    await client.send_file(
                        entity,
                        'movie.mp4',
                        caption=f'ðŸŽ¥ {CONTENT_NAME}\nâœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­'
                    )
                    print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
                    
                    # ØªÙ†Ø¸ÙŠÙ
                    if os.path.exists('movie.mp4'):
                        os.remove('movie.mp4')
                        
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {e}")
                    return False
                
                print("\n" + "=" * 50)
                print("ðŸŽ‰ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø®Ø§ØµØ©!")
                print("=" * 50)
                return True
                
            except Exception as e:
                print(f"ðŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
                return False
                
            finally:
                if client:
                    await client.disconnect()
                    print("\nðŸ”’ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
        
        # Ø§Ù„ØªØ´ØºÙŠÙ„
        if __name__ == "__main__":
            try:
                success = asyncio.run(main())
                if success:
                    sys.exit(0)
                else:
                    sys.exit(1)
            except KeyboardInterrupt:
                print("\nâ¹ï¸  ØªÙˆÙ‚Ù ÙŠØ¯ÙˆÙŠ")
                sys.exit(1)
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©"
        
    - name: âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        INVITE_LINK: ${{ github.event.inputs.invite_link }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø®Ø§ØµØ©..."
        echo "========================================"
        python3 upload_with_invite.py
        echo "========================================"
        
    - name: ðŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo "ðŸ•’ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: $(date)"
        echo "ðŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: ${{ job.status }}"
