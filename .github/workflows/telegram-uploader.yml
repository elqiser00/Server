# .github/workflows/telegram-uploader.yml
name: ðŸŽ¬ Telegram Movie Uploader

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡'
        required: true
        default: 'upload_image'
        type: choice
        options:
        - upload_image
        - upload_video
        - test_connection
      invite_link:
        description: 'Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø§Ù„Ù‚Ù†Ø§Ø©'
        required: true
        default: 'https://t.me/+VvLRMffUCXNlNjRk'
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        default: 'Truth & Treason 2025'
        type: string
      media_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù (ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ)'
        required: true
        type: string

jobs:
  telegram_upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
      run: |
        echo "========================================"
        echo "ðŸŽ¬ Telegram Upload System"
        echo "========================================"
        echo "Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${{ github.event.inputs.action_type }}"
        echo "Ø§Ù„Ù‚Ù†Ø§Ø©: ${{ github.event.inputs.invite_link }}"
        echo "Ø§Ù„ÙÙŠÙ„Ù…: ${{ github.event.inputs.content_name }}"
        echo "========================================"
    
    - name: âš™ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget
        pip3 install telethon --quiet
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª telethon"
        
    - name: ðŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø°ÙƒÙŠ
      run: |
        cat > telegram_uploader.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        
        print("ðŸ¤– Telegram Uploader Script")
        print("=" * 50)
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        ACTION_TYPE = os.environ.get('ACTION_TYPE', 'test_connection')
        INVITE_LINK = os.environ.get('INVITE_LINK', '')
        CONTENT_NAME = os.environ.get('CONTENT_NAME', '')
        MEDIA_URL = os.environ.get('MEDIA_URL', '')
        
        # Ù‚Ø±Ø§Ø¡Ø© Secrets
        API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
        
        print(f"âš¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: {ACTION_TYPE}")
        print(f"ðŸŽ¬ Ø§Ù„ÙÙŠÙ„Ù…: {CONTENT_NAME}")
        print(f"ðŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: {MEDIA_URL[:50]}...")
        print("=" * 50)
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        async def test_connection(client):
            """Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„"""
            print("\nðŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...")
            try:
                me = await client.get_me()
                print(f"âœ… Ù…ØªØµÙ„ ÙƒÙ€: {me.first_name} (@{me.username})")
                print(f"ðŸ“ž Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {me.phone}")
                return True
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£: {e}")
                return False
        
        async def upload_media(client, channel, media_path, is_video=False):
            """Ø±ÙØ¹ Ù…Ù„Ù ÙˆØ³Ø§Ø¦Ø·"""
            try:
                file_size = os.path.getsize(media_path)
                size_mb = file_size / (1024 * 1024)
                
                if is_video:
                    print(f"ðŸŽ¥ Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ ({size_mb:.1f} MB)...")
                    caption = f'ðŸŽ¥ **{CONTENT_NAME}**\nðŸ“Š Ø§Ù„Ø­Ø¬Ù…: {size_mb:.1f} MB'
                    supports_streaming = True
                else:
                    print(f"ðŸ“¸ Ø±ÙØ¹ ØµÙˆØ±Ø© ({size_mb:.1f} MB)...")
                    caption = f'ðŸŽ¬ **{CONTENT_NAME}**\nðŸ“¸ Ø¨ÙˆØ³ØªØ± Ø§Ù„ÙÙŠÙ„Ù…'
                    supports_streaming = False
                
                await client.send_file(
                    channel,
                    media_path,
                    caption=caption,
                    supports_streaming=supports_streaming
                )
                
                print(f"âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!")
                return True
                
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: {e}")
                return False
        
        async def main():
            print("\nðŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram...")
            
            client = None
            try:
                # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH,
                    connection_retries=3
                )
                
                await client.connect()
                
                # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
                if not await test_connection(client):
                    return False
                
                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©
                print(f"\nðŸ“¢ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù†Ø§Ø©...")
                channel = await client.get_entity(INVITE_LINK)
                print(f"âœ… Ø§Ù„Ù‚Ù†Ø§Ø©: {channel.title}")
                
                # ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                if ACTION_TYPE == 'upload_image':
                    # Ø±ÙØ¹ ØµÙˆØ±Ø©
                    print(f"\nâ¬‡ï¸  ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...")
                    subprocess.run(['wget', '-q', '-O', 'media.jpg', MEDIA_URL], check=True)
                    
                    success = await upload_media(client, channel, 'media.jpg', False)
                    
                elif ACTION_TYPE == 'upload_video':
                    # Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ
                    print(f"\nâ¬‡ï¸  ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                    result = subprocess.run([
                        'wget',
                        '--no-check-certificate',
                        '-c',
                        '--timeout=60',
                        '--tries=3',
                        '--show-progress',
                        '-O', 'media.mp4',
                        MEDIA_URL
                    ], capture_output=True, text=True)
                    
                    if result.returncode != 0:
                        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {result.stderr}")
                        return False
                    
                    success = await upload_media(client, channel, 'media.mp4', True)
                    
                else:  # test_connection
                    print("\nâœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­!")
                    success = True
                
                return success
                
            except Exception as e:
                print(f"\nðŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {type(e).__name__}")
                print(f"ðŸ“ {str(e)[:200]}")
                return False
                
            finally:
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                for file in ['media.jpg', 'media.mp4']:
                    if os.path.exists(file):
                        os.remove(file)
                        print(f"ðŸ—‘ï¸  ØªÙ… Ø­Ø°Ù {file}")
                
                if client:
                    await client.disconnect()
                    print("\nðŸ”’ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
        
        # Ø§Ù„ØªØ´ØºÙŠÙ„
        if __name__ == "__main__":
            success = asyncio.run(main())
            sys.exit(0 if success else 1)
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ±Ø¨Øª"
        
    - name: âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        ACTION_TYPE: ${{ github.event.inputs.action_type }}
        INVITE_LINK: ${{ github.event.inputs.invite_link }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        MEDIA_URL: ${{ github.event.inputs.media_url }}
      run: |
        echo "âš¡ ØªØ´ØºÙŠÙ„: ${{ github.event.inputs.action_type }}"
        echo "========================================"
        python3 telegram_uploader.py
        echo "========================================"
        
    - name: ðŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo "ðŸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª!"
        echo "ðŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date '+%H:%M:%S')"
