# .github/workflows/telegram-uploader.yml

name: Telegram Movie Uploader

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø© (ID Ø§Ù„Ù‚Ù†Ø§Ø©)'
        required: true
        type: string
        default: '1548535280'
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        type: string
        default: 'Truth & Treason 2025'
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        type: string
        default: 'https://img.downet.net/uploads/U8xQf.webp'
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (.mp4 ÙÙ‚Ø·)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check inputs
      run: |
        echo "========================================"
        echo "ðŸŽ¬ Telegram Movie Uploader"
        echo "========================================"
        echo "Movie: ${{ github.event.inputs.content_name }}"
        echo "Chat ID: ${{ github.event.inputs.chat_id }}"
        echo "Image: ${{ github.event.inputs.image_url }}"
        echo "Video: ${{ github.event.inputs.video_url }}"
        echo "Time: $(date)"
        echo "========================================"
    
    - name: Setup Python
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip wget
        
    - name: Install dependencies
      run: |
        pip3 install telethon
        
    - name: Create upload script
      run: |
        cat > upload.py << 'EOF'
        import asyncio
        import os
        import sys
        
        # Get credentials from secrets
        API_ID = int(os.environ['TELEGRAM_API_ID'])
        API_HASH = os.environ['TELEGRAM_API_HASH']
        SESSION_STRING = os.environ['TELEGRAM_SESSION_STRING']
        
        # Get inputs from workflow
        CHAT_ID = int(os.environ['CHAT_ID'])
        CONTENT_NAME = os.environ['CONTENT_NAME']
        IMAGE_URL = os.environ['IMAGE_URL']
        VIDEO_URL = os.environ['VIDEO_URL']
        
        print(f"ðŸ”§ Configuration:")
        print(f"  Chat ID: {CHAT_ID}")
        print(f"  Movie: {CONTENT_NAME}")
        print(f"  Image: {IMAGE_URL}")
        print(f"  Video: {VIDEO_URL}")
        
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        import subprocess
        
        async def upload_to_telegram():
            print("ðŸš€ Starting Telegram upload...")
            
            # Create client
            client = TelegramClient(
                StringSession(SESSION_STRING),
                API_ID,
                API_HASH
            )
            
            await client.connect()
            
            # Check connection
            me = await client.get_me()
            print(f"âœ… Connected as: {me.first_name}")
            
            try:
                # Download image
                print("ðŸ“¥ Downloading image...")
                subprocess.run(['wget', '-O', 'poster.jpg', IMAGE_URL], check=True)
                
                # Upload image
                print("ðŸ“¤ Uploading image...")
                await client.send_file(
                    CHAT_ID,
                    'poster.jpg',
                    caption=f'ðŸŽ¬ {CONTENT_NAME}\nðŸ“¤ Uploaded via GitHub'
                )
                print("âœ… Image uploaded")
                
                # Download video
                print("ðŸ“¥ Downloading video...")
                subprocess.run(['wget', '-O', 'movie.mp4', VIDEO_URL], check=True)
                
                # Upload video
                print("ðŸ“¤ Uploading video...")
                await client.send_file(
                    CHAT_ID,
                    'movie.mp4',
                    caption=f'ðŸŽ¥ {CONTENT_NAME}\nâœ… Upload complete'
                )
                print("âœ… Video uploaded")
                
                print("ðŸŽ‰ Upload completed successfully!")
                
            except Exception as e:
                print(f"âŒ Error: {e}")
                raise
            finally:
                await client.disconnect()
                print("ðŸ”’ Disconnected from Telegram")
                
                # Cleanup
                if os.path.exists('poster.jpg'):
                    os.remove('poster.jpg')
                if os.path.exists('movie.mp4'):
                    os.remove('movie.mp4')
        
        if __name__ == "__main__":
            asyncio.run(upload_to_telegram())
        EOF
        
        echo "ðŸ“ Script created"
        
    - name: Run upload
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ Running upload script..."
        python3 upload.py
        
    - name: Upload result
      if: always()
      run: |
        echo "========================================"
        echo "ðŸ“Š Upload completed"
        echo "Status: ${{ job.status }}"
        echo "========================================"
