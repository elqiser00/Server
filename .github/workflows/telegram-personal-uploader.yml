# .github/workflows/telegram-auto-uploader.yml

name: Telegram Auto Uploader

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø©/Ø§Ù„Ø¬Ø±ÙˆØ¨'
        required: true
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        type: string
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (.mp4 ÙÙ‚Ø·)'
        required: true
        type: string
      skip_ssl:
        description: 'ØªØ¬Ø§ÙˆØ² Ù…Ø´Ø§ÙƒÙ„ SSL'
        required: false
        type: boolean
        default: true

env:
  REPO_OWNER: elqiser00
  REPO_NAME: Server

jobs:
  upload-movie:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      run: |
        echo "ğŸ¬ Ø¨Ø¯Ø¡ Ø±ÙØ¹ ÙÙŠÙ„Ù… Ø¥Ù„Ù‰ Telegram"
        echo "ğŸ“ Ø§Ù„Ø§Ø³Ù…: ${{ github.event.inputs.content_name }}"
        echo "ğŸ‘¥ Ø¥Ù„Ù‰: ${{ github.event.inputs.chat_id }}"
        echo "ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø©: ${{ github.event.inputs.image_url }}"
        echo "ğŸ¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${{ github.event.inputs.video_url }}"
        echo "ğŸ”“ ØªØ¬Ø§ÙˆØ² SSL: ${{ github.event.inputs.skip_ssl }}"
        echo "â° Ø§Ù„ÙˆÙ‚Øª: $(date)"
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          curl \
          ffmpeg \
          python3 \
          python3-pip \
          ca-certificates
        
        # ØªØ­Ø¯ÙŠØ« Ø´Ù‡Ø§Ø¯Ø§Øª SSL
        sudo update-ca-certificates --fresh
        
        # ØªØ«Ø¨ÙŠØª Telethon
        pip3 install telethon
        
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª"
        
    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ù…Ø¹ SSL
      run: |
        cat > upload_with_ssl.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        import ssl
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Secrets
        API_ID = int(os.environ.get('TELEGRAM_API_ID'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING')
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub
        CHAT_ID = os.environ.get('CHAT_ID')
        CONTENT_NAME = os.environ.get('CONTENT_NAME')
        IMAGE_URL = os.environ.get('IMAGE_URL')
        VIDEO_URL = os.environ.get('VIDEO_URL')
        SKIP_SSL = os.environ.get('SKIP_SSL', 'true').lower() == 'true'
        
        def log(message):
            print(f'[INFO] {message}', flush=True)
        
        def download_file_advanced(url, filename, skip_ssl=True):
            """ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©"""
            log(f'Ø¨Ø¯Ø¡ ØªÙ†Ø²ÙŠÙ„: {filename}')
            
            # Ø¨Ù†Ø§Ø¡ Ø£Ù…Ø± wget Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
            cmd = ['wget']
            
            if skip_ssl:
                cmd.extend([
                    '--no-check-certificate',
                    '--retry-connrefused',
                    '--retry-on-http-error=403,404,500,502,503,504'
                ])
            
            cmd.extend([
                '--timeout=30',
                '--tries=3',
                '--waitretry=5',
                '--user-agent=Mozilla/5.0',
                '--progress=dot:giga',
                '-O', filename,
                url
            ])
            
            try:
                result = subprocess.run(cmd, capture_output=True, text=True)
                
                if result.returncode == 0:
                    log(f'âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„: {filename}')
                    
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
                    if os.path.exists(filename):
                        size = os.path.getsize(filename) / (1024 * 1024)
                        log(f'ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: {size:.2f} MB')
                        return True
                    else:
                        log(f'âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {filename}')
                        return False
                else:
                    log(f'âŒ ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {result.stderr}')
                    
                    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… curl
                    log('ğŸ”„ ØªØ¬Ø±Ø¨Ø© Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… curl...')
                    curl_cmd = [
                        'curl',
                        '-L',  # Ø§ØªØ¨Ø¹ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª
                        '--retry', '3',
                        '--retry-delay', '5',
                        '--connect-timeout', '30',
                        '-o', filename,
                        url
                    ]
                    
                    if skip_ssl:
                        curl_cmd.extend(['-k'])  # ØªØ¬Ø§ÙˆØ² SSL
                    
                    result2 = subprocess.run(curl_cmd, capture_output=True, text=True)
                    if result2.returncode == 0:
                        log(f'âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… curl: {filename}')
                        return True
                    
                    return False
                    
            except Exception as e:
                log(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {e}')
                return False
        
        async def main():
            log('=== Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© ===')
            
            # ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…
            import re
            clean_name = re.sub(r'[<>:"/\\|?*]', '', CONTENT_NAME).strip()
            clean_name = re.sub(r'\s+', ' ', clean_name)
            
            log(f'ğŸ“ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ø¸ÙŠÙ: {clean_name}')
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Telegram
            client = TelegramClient(
                StringSession(SESSION_STRING),
                API_ID,
                API_HASH
            )
            
            try:
                # Ø§Ù„Ø§ØªØµØ§Ù„
                await client.connect()
                log('âœ… Ù…ØªØµÙ„ Ø¨Ù€ Telegram')
                
                # 1. ØªÙ†Ø²ÙŠÙ„ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                image_filename = f"{clean_name}_poster.jpg"
                log(f'ğŸ–¼ï¸ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...')
                
                if download_file_advanced(IMAGE_URL, image_filename, SKIP_SSL):
                    log(f'ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...')
                    await client.send_file(
                        CHAT_ID,
                        image_filename,
                        caption=f'ğŸ¬ {CONTENT_NAME}\nğŸ“¤ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± GitHub'
                    )
                    log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©')
                else:
                    log('âŒ ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©')
                
                # 2. ØªÙ†Ø²ÙŠÙ„ ÙˆØ±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                video_filename = f"{clean_name}.mp4"
                log(f'ğŸ¥ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...')
                
                if download_file_advanced(VIDEO_URL, video_filename, SKIP_SSL):
                    log(f'ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...')
                    
                    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ ØªÙ‚Ø¯Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                    file_size = os.path.getsize(video_filename) / (1024 * 1024)
                    
                    await client.send_file(
                        CHAT_ID,
                        video_filename,
                        caption=f'ğŸ¥ {CONTENT_NAME}\nğŸ“ {video_filename}\nğŸ“Š Ø§Ù„Ø­Ø¬Ù…: {file_size:.2f} MB\nâœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­'
                    )
                    log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ')
                else:
                    log('âŒ ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ')
                
                log('ğŸ‰ ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!')
                
            except Exception as e:
                log(f'âŒ Ø®Ø·Ø£: {str(e)}')
                sys.exit(1)
            finally:
                await client.disconnect()
                log('ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„')
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                log('ğŸ§¹ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©...')
                os.system("rm -f *.mp4 *.jpg *.jpeg *.png 2>/dev/null || true")
                log('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ')
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "ğŸ“„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"
        
    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
        SKIP_SSL: ${{ github.event.inputs.skip_ssl }}
      run: |
        echo "âš¡ Ø¨Ø¯Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ù…Ø¹ SSL..."
        python3 upload_with_ssl.py
        
    - name: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
      run: |
        echo "âœ… ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:"
        echo "   Ø§Ù„ÙÙŠÙ„Ù…: ${{ github.event.inputs.content_name }}"
        echo "   Ø¥Ù„Ù‰: ${{ github.event.inputs.chat_id }}"
        echo "   Ø§Ù„ÙˆÙ‚Øª: $(date)"
        echo "   Ø§Ù„Ø­Ø§Ù„Ø©: âœ… Ù†Ø§Ø¬Ø­"
        
    - name: Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£ (Ø¥Ø°Ø§ ÙØ´Ù„Øª)
      if: failure()
      run: |
        echo "âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹"
        echo "ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date)"
        echo "ğŸ”§ ØªØ­Ù‚Ù‚ Ù…Ù†:"
        echo "   1. ØµØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·"
        echo "   2. ÙˆØ¬ÙˆØ¯ Secrets"
        echo "   3. Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"
        exit 1
