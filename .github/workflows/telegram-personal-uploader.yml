# .github/workflows/telegram-uploader-fixed.yml

name: Telegram Movie Uploader - Fixed

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'ูุนุฑู ุงูููุงุฉ/ุงูุฌุฑูุจ'
        required: true
        type: string
        default: '1548535280-'
      content_name:
        description: 'ุงุณู ุงููููู'
        required: true
        type: string
        default: 'Truth & Treason 2025'
      image_url:
        description: 'ุฑุงุจุท ุตูุฑุฉ ุงูุบูุงู'
        required: true
        type: string
        default: 'https://img.downet.net/uploads/U8xQf.webp'
      video_url:
        description: 'ุฑุงุจุท ุงูููุฏูู (.mp4 ููุท)'
        required: true
        type: string

env:
  # ููู ุงูุชุฑุงุถูุฉ ููุชุญูู
  TEST_MODE: false

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
      run: |
        echo "๐ฌ ========================================"
        echo "๐ฌ ุจุฏุก ุฑูุน ูููู ุฅูู Telegram"
        echo "๐ฌ ========================================"
        echo "๐ ุงุณู ุงููููู: ${{ github.event.inputs.content_name }}"
        echo "๐ฅ ุฅูู: ${{ github.event.inputs.chat_id }}"
        echo "๐ผ๏ธ ุงูุตูุฑุฉ: ${{ github.event.inputs.image_url }}"
        echo "๐ฅ ุงูููุฏูู: ${{ github.event.inputs.video_url }}"
        echo "โฐ ุงูููุช: $(date)"
        echo "๐ฌ ========================================"
        
    - name: ุชุซุจูุช ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ
      run: |
        echo "๐ง ุฌุงุฑู ุชุซุจูุช ุงููุชุทูุจุงุช..."
        sudo apt-get update -y
        sudo apt-get install -y wget python3 python3-pip
        
        echo "โ ุชู ุชุซุจูุช ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ"
        
    - name: ุชุซุจูุช Telethon
      run: |
        echo "๐ ุฌุงุฑู ุชุซุจูุช Telethon..."
        pip3 install telethon --quiet
        echo "โ ุชู ุชุซุจูุช Telethon"
        
    - name: ุฅูุดุงุก ุณูุฑุจุช ุงูุฑูุน ุงููุตุญุญ
      run: |
        cat > upload_fixed.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        print("๐ ุจุฏุก ุณูุฑุจุช ุงูุฑูุน ุงููุตุญุญ...")
        
        # ุจูุงูุงุช ูู Secrets
        try:
            API_ID = int(os.environ.get('TELEGRAM_API_ID', '0'))
            API_HASH = os.environ.get('TELEGRAM_API_HASH', '')
            SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING', '')
            
            # ุจูุงูุงุช ูู GitHub
            CHAT_ID = os.environ.get('CHAT_ID', '')
            CONTENT_NAME = os.environ.get('CONTENT_NAME', '')
            IMAGE_URL = os.environ.get('IMAGE_URL', '')
            VIDEO_URL = os.environ.get('VIDEO_URL', '')
            
            print(f"โ ุชู ุชุญููู ุงูุจูุงูุงุช:")
            print(f"   API_ID: {API_ID}")
            print(f"   API_HASH: {API_HASH[:10]}...")  # ุนุฑุถ ุฃูู 10 ุฃุญุฑู ููุท
            print(f"   SESSION_STRING: {SESSION_STRING[:20]}...")
            print(f"   CHAT_ID: {CHAT_ID}")
            print(f"   CONTENT_NAME: {CONTENT_NAME}")
            print(f"   IMAGE_URL: {IMAGE_URL}")
            print(f"   VIDEO_URL: {VIDEO_URL}")
            
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: {e}")
            sys.exit(1)
        
        def log(message, level='INFO'):
            print(f'[{level}] {message}', flush=True)
        
        def download_file(url, filename, retries=3):
            """ุชูุฒูู ููู ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ"""
            for attempt in range(retries):
                try:
                    log(f'ูุญุงููุฉ ุชูุฒูู {filename} (ุงููุญุงููุฉ {attempt + 1}/{retries})')
                    
                    cmd = [
                        'wget',
                        '--no-check-certificate',  # ุชุฌุงูุฒ SSL
                        '-c',                      # ุงุณุชุฆูุงู ุงูุชุญููู
                        '--timeout=30',
                        '--tries=3',
                        '--user-agent=Mozilla/5.0',
                        '-O', filename,
                        url
                    ]
                    
                    result = subprocess.run(cmd, capture_output=True, text=True)
                    
                    if result.returncode == 0:
                        if os.path.exists(filename):
                            size = os.path.getsize(filename)
                            log(f'โ ุชู ุชูุฒูู {filename} ({size:,} ุจุงูุช)', 'SUCCESS')
                            return True
                        else:
                            log(f'โ ุงูููู ุบูุฑ ููุฌูุฏ ุจุนุฏ ุงูุชูุฒูู: {filename}', 'ERROR')
                    else:
                        log(f'โ ูุดู ุงูุชูุฒูู: {result.stderr}', 'ERROR')
                        
                except Exception as e:
                    log(f'โ ุฎุทุฃ ูู ุงูุชูุฒูู: {e}', 'ERROR')
                
                if attempt < retries - 1:
                    log(f'๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ 5 ุซูุงู...')
                    import time
                    time.sleep(5)
            
            return False
        
        def clean_filename(name):
            """ุชูุธูู ุงุณู ุงูููู"""
            import re
            # ุฅุฒุงูุฉ ุงูุฃุญุฑูู ุบูุฑ ุงููุณููุญ ุจูุง
            name = re.sub(r'[<>:"/\\|?*]', '', name)
            # ุงุณุชุจุฏุงู ุงููุณุงูุงุช ุงููุชุนุฏุฏุฉ
            name = re.sub(r'\s+', ' ', name)
            return name.strip()
        
        async def main():
            log('=== ุจุฏุก ุนูููุฉ ุงูุฑูุน ุงูุฑุฆูุณูุฉ ===')
            
            # ุชูุธูู ุงุณู ุงููููู
            clean_name = clean_filename(CONTENT_NAME)
            log(f'๐ ุงูุงุณู ุจุนุฏ ุงูุชูุธูู: {clean_name}')
            
            # ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
            if not all([API_ID, API_HASH, SESSION_STRING]):
                log('โ ุจูุงูุงุช Telegram ุบูุฑ ููุชููุฉ', 'ERROR')
                sys.exit(1)
            
            if not VIDEO_URL:
                log('โ ุฑุงุจุท ุงูููุฏูู ูุทููุจ', 'ERROR')
                sys.exit(1)
            
            # ุฅูุดุงุก ุนููู Telegram
            try:
                client = TelegramClient(
                    StringSession(SESSION_STRING),
                    API_ID,
                    API_HASH
                )
                
                await client.connect()
                log('โ ุชู ุงูุงุชุตุงู ุจู Telegram', 'SUCCESS')
                
                # ุงูุชุญูู ูู ุงูุงุชุตุงู
                me = await client.get_me()
                log(f'โ ูุชุตู ูู: {me.first_name} (@{me.username if me.username else "ูุง ููุฌุฏ"})', 'SUCCESS')
                
            except Exception as e:
                log(f'โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Telegram: {e}', 'ERROR')
                sys.exit(1)
            
            try:
                # 1. ุชูุฒูู ุงูุตูุฑุฉ
                image_filename = f"{clean_name}_poster.jpg"
                if download_file(IMAGE_URL, image_filename):
                    log(f'๐ค ุฌุงุฑู ุฑูุน ุงูุตูุฑุฉ: {image_filename}')
                    
                    # ุฑูุน ุงูุตูุฑุฉ
                    await client.send_file(
                        CHAT_ID,
                        image_filename,
                        caption=f'๐ฌ {CONTENT_NAME}\n๐ค ุชู ุงูุฑูุน ุนุจุฑ GitHub'
                    )
                    log('โ ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ', 'SUCCESS')
                else:
                    log('โ ูุดู ุชูุฒูู ุงูุตูุฑุฉ', 'ERROR')
                
                # 2. ุชูุฒูู ุงูููุฏูู
                video_filename = f"{clean_name}.mp4"
                if download_file(VIDEO_URL, video_filename):
                    log(f'๐ค ุฌุงุฑู ุฑูุน ุงูููุฏูู: {video_filename}')
                    
                    # ุงูุญุตูู ุนูู ุญุฌู ุงูููุฏูู
                    video_size = os.path.getsize(video_filename)
                    size_mb = video_size / (1024 * 1024)
                    
                    # ุฑูุน ุงูููุฏูู
                    await client.send_file(
                        CHAT_ID,
                        video_filename,
                        caption=f'๐ฅ {CONTENT_NAME}\n๐ {video_filename}\n๐ ุงูุญุฌู: {size_mb:.2f} MB\nโ ุชู ุงูุฑูุน ุจูุฌุงุญ'
                    )
                    log('โ ุชู ุฑูุน ุงูููุฏูู ุจูุฌุงุญ', 'SUCCESS')
                else:
                    log('โ ูุดู ุชูุฒูู ุงูููุฏูู', 'ERROR')
                
                log('๐ ุชู ุงูุชูุงู ุนูููุฉ ุงูุฑูุน ุจูุฌุงุญ!', 'SUCCESS')
                
            except Exception as e:
                log(f'โ ุฎุทุฃ ุฃุซูุงุก ุงูุฑูุน: {e}', 'ERROR')
                sys.exit(1)
                
            finally:
                # ูุทุน ุงูุงุชุตุงู
                await client.disconnect()
                log('๐ ุชู ูุทุน ุงูุงุชุตุงู ุจู Telegram')
                
                # ุชูุธูู ุงููููุงุช
                log('๐งน ุฌุงุฑู ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ...')
                try:
                    files = [f for f in os.listdir('.') if f.endswith(('.mp4', '.jpg', '.jpeg', '.png'))]
                    for f in files:
                        os.remove(f)
                        log(f'๐๏ธ ุชู ุญุฐู: {f}')
                except Exception as e:
                    log(f'โ๏ธ ุฎุทุฃ ูู ุงูุชูุธูู: {e}', 'WARNING')
                
                log('โ ุชู ุงูุชูุธูู', 'SUCCESS')
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "๐ ุชู ุฅูุดุงุก ุณูุฑุจุช ุงูุฑูุน ุงููุตุญุญ"
        echo "๐ ุฌุงุฑู ูุญุต ุงูุณูุฑุจุช..."
        python3 -m py_compile upload_fixed.py
        echo "โ ุงูุณูุฑุจุช ุตุญูุญ ุงููุญู"
        
    - name: ุชุดุบูู ุณูุฑุจุช ุงูุฑูุน
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "โก ุชุดุบูู ุณูุฑุจุช ุงูุฑูุน ุงููุตุญุญ..."
        echo "========================================"
        python3 upload_fixed.py
        echo "========================================"
        
    - name: ุนุฑุถ ูุชูุฌุฉ ุงูุชูููุฐ
      if: always()
      run: |
        echo "๐ ========================================"
        echo "๐ ูุชูุฌุฉ ุชูููุฐ ุงูู Action"
        echo "๐ ========================================"
        echo "๐ ููุช ุงูุงูุชูุงุก: $(date)"
        echo "๐ ุงุณู ุงููููู: ${{ github.event.inputs.content_name }}"
        echo "๐ ุฑุงุจุท ุงูููุฏูู: ${{ github.event.inputs.video_url }}"
        echo "๐ ุงูุญุงูุฉ: ${{ job.status }}"
        echo "๐ ========================================"
