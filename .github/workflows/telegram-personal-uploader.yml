# .github/workflows/telegram-uploader.yml

name: Telegram Movie Uploader

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø©/Ø§Ù„Ø¬Ø±ÙˆØ¨ (Ù…Ø«Ø§Ù„: -1001234567890)'
        required: true
        type: string
        default: '1548535280-'
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…'
        required: true
        type: string
        default: 'Truth & Treason 2025'
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        type: string
        default: 'https://img.downet.net/uploads/U8xQf.webp'
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (.mp4 ÙÙ‚Ø·)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      run: |
        echo "ğŸ¬ Ø¨Ø¯Ø¡ Ø±ÙØ¹ ÙÙŠÙ„Ù… Ø¥Ù„Ù‰ Telegram"
        echo "========================================"
        echo "ğŸ“ Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…: ${{ github.event.inputs.content_name }}"
        echo "ğŸ‘¥ Ø¥Ù„Ù‰: ${{ github.event.inputs.chat_id }}"
        echo "ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø©: ${{ github.event.inputs.image_url }}"
        echo "ğŸ¥ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${{ github.event.inputs.video_url }}"
        echo "â° Ø§Ù„ÙˆÙ‚Øª: $(date)"
        echo "========================================"
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      run: |
        echo "ğŸ”§ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª..."
        apt-get update
        apt-get install -y wget ffmpeg python3 python3-pip
        
        echo "ğŸ ØªØ«Ø¨ÙŠØª Telethon..."
        pip3 install telethon
        
        echo "âœ… ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª"
        
    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      run: |
        cat > upload.py << 'EOF'
        import asyncio
        import os
        import sys
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Secrets
        API_ID = int(os.environ['TELEGRAM_API_ID'])
        API_HASH = os.environ['TELEGRAM_API_HASH']
        SESSION_STRING = os.environ['TELEGRAM_SESSION_STRING']
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub
        CHAT_ID = os.environ['CHAT_ID']
        CONTENT_NAME = os.environ['CONTENT_NAME']
        IMAGE_URL = os.environ['IMAGE_URL']
        VIDEO_URL = os.environ['VIDEO_URL']
        
        async def main():
            print("ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹...")
            
            # ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…
            import re
            clean_name = re.sub(r'[<>:"/\\|?*]', '', CONTENT_NAME).strip()
            clean_name = re.sub(r'\s+', ' ', clean_name)
            
            print(f"ğŸ“ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ø¸ÙŠÙ: {clean_name}")
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Telegram
            client = TelegramClient(
                StringSession(SESSION_STRING),
                API_ID,
                API_HASH
            )
            
            try:
                # Ø§Ù„Ø§ØªØµØ§Ù„
                await client.connect()
                print("âœ… Ù…ØªØµÙ„ Ø¨Ù€ Telegram")
                
                # 1. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                print("ğŸ–¼ï¸ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...")
                os.system(f'wget -O "poster.jpg" "{IMAGE_URL}"')
                
                # 2. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                print("ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...")
                await client.send_file(
                    CHAT_ID,
                    'poster.jpg',
                    caption=f'ğŸ¬ {CONTENT_NAME}\nğŸ“¤ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± GitHub'
                )
                print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©")
                
                # 3. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print("ğŸ¥ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                video_name = f"{clean_name}.mp4"
                os.system(f'wget -O "{video_name}" "{VIDEO_URL}"')
                
                # 4. Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                print("ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
                await client.send_file(
                    CHAT_ID,
                    video_name,
                    caption=f'ğŸ¥ {CONTENT_NAME}\nğŸ“ {video_name}\nâœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­'
                )
                print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
                
                print("ğŸ‰ ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!")
                
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£: {e}")
                sys.exit(1)
            finally:
                await client.disconnect()
                print("ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                print("ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª...")
                os.system("rm -f *.mp4 *.jpg 2>/dev/null || true")
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "ğŸ“„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹"
        
    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
      run: |
        echo "âš¡ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹..."
        python3 upload.py
        
    - name: Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
      run: |
        echo "========================================"
        echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠÙ„Ù… Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“ Ø§Ù„Ø§Ø³Ù…: ${{ github.event.inputs.content_name }}"
        echo "ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date)"
        echo "========================================"
