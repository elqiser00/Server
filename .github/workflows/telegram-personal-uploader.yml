# .github/workflows/telegram-uploader.yml

name: Telegram Personal Uploader

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø©/Ø§Ù„Ø¬Ø±ÙˆØ¨'
        required: true
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…/Ø§Ù„Ù…Ø³Ù„Ø³Ù„'
        required: true
        type: string
      content_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰'
        required: true
        type: choice
        options:
        - movie
        - series
      image_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù'
        required: true
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ù„ÙÙŠÙ„Ù… ÙÙ‚Ø·)'
        required: false
        type: string
      episodes:
        description: 'Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø­Ù„Ù‚Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„ Ù„Ù„Ù…Ø³Ù„Ø³Ù„)'
        required: false
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Telegram"
        echo "ğŸ“ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${{ github.event.inputs.content_name }}"
        echo "ğŸ¬ Ø§Ù„Ù†ÙˆØ¹: ${{ github.event.inputs.content_type }}"
        echo "â° Ø§Ù„ÙˆÙ‚Øª: $(date)"
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        apt-get update
        apt-get install -y \
          wget \
          ffmpeg \
          python3 \
          python3-pip \
          curl
        
        pip3 install telethon requests
        
    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      run: |
        cat > upload_script.py << 'EOF'
        import asyncio
        import os
        import sys
        import re
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        import subprocess
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Secrets
        API_ID = int(os.environ.get('TELEGRAM_API_ID'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING')
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† workflow inputs
        CHAT_ID = os.environ.get('CHAT_ID')
        CONTENT_NAME = os.environ.get('CONTENT_NAME')
        CONTENT_TYPE = os.environ.get('CONTENT_TYPE')
        IMAGE_URL = os.environ.get('IMAGE_URL')
        VIDEO_URL = os.environ.get('VIDEO_URL', '')
        EPISODES = os.environ.get('EPISODES', '').split(',')
        
        def clean_filename(name):
            """ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø£Ø­Ø±ÙˆÙ ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§"""
            # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±ÙˆÙ Ø§Ù„Ø®Ø§ØµØ©
            name = re.sub(r'[<>:"/\\|?*]', '', name)
            # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
            name = re.sub(r'\s+', ' ', name)
            return name.strip()
        
        def download_file(url, filename):
            """ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… wget"""
            print(f"ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„: {filename}")
            try:
                cmd = [
                    'wget',
                    '--no-check-certificate',
                    '-c',  # Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    '-O', filename,
                    url
                ]
                
                result = subprocess.run(cmd, capture_output=True, text=True)
                if result.returncode == 0:
                    print(f"âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„: {filename}")
                    return True
                else:
                    print(f"âŒ ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„: {filename}")
                    print(f"Ø®Ø·Ø£: {result.stderr}")
                    return False
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: {e}")
                return False
        
        async def main():
            print("=== Ø¨Ø¯Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ ===")
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Telegram Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… session string
            client = TelegramClient(StringSession(SESSION_STRING), API_ID, API_HASH)
            
            try:
                # Ø§Ù„Ø§ØªØµØ§Ù„
                await client.connect()
                print("âœ… Ù…ØªØµÙ„ Ø¨Ù€ Telegram")
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                clean_content_name = clean_filename(CONTENT_NAME)
                print(f"ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰: {clean_content_name}")
                
                # ØªÙ†Ø²ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù
                image_ext = '.jpg'  # ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ø­Ø³Ø¨ Ø§Ù„ØµÙˆØ±Ø©
                image_filename = f"{clean_content_name}_poster{image_ext}"
                
                if download_file(IMAGE_URL, image_filename):
                    # Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                    print(f"ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: {image_filename}")
                    await client.send_file(
                        CHAT_ID,
                        image_filename,
                        caption=f"ğŸ¬ {CONTENT_NAME}\nâœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± GitHub"
                    )
                    print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©")
                
                if CONTENT_TYPE == 'movie':
                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠÙ„Ù…
                    if VIDEO_URL:
                        # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                        video_filename = f"{clean_content_name}.mp4"
                        if download_file(VIDEO_URL, video_filename):
                            # Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                            print(f"ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {video_filename}")
                            await client.send_file(
                                CHAT_ID,
                                video_filename,
                                caption=f"ğŸ¥ {CONTENT_NAME}\nğŸ“ {video_filename}"
                            )
                            print("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
                
                elif CONTENT_TYPE == 'series':
                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ù„Ø³Ù„
                    episodes_list = [url.strip() for url in EPISODES if url.strip()]
                    
                    for i, episode_url in enumerate(episodes_list, 1):
                        episode_filename = f"{clean_content_name} - Ø§Ù„Ø­Ù„Ù‚Ø© {i}.mp4"
                        
                        if download_file(episode_url, episode_filename):
                            # Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø©
                            print(f"ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø© {i}: {episode_filename}")
                            await client.send_file(
                                CHAT_ID,
                                episode_filename,
                                caption=f"ğŸ“º {CONTENT_NAME} - Ø§Ù„Ø­Ù„Ù‚Ø© {i}\nğŸ“ {episode_filename}"
                            )
                            print(f"âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø© {i}")
                            await asyncio.sleep(1)  # ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø­Ù„Ù‚Ø§Øª
                
                print("âœ… ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!")
                
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£: {e}")
                sys.exit(1)
            finally:
                await client.disconnect()
                print("ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„")
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                print("ğŸ§¹ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©...")
                os.system("rm -f *.mp4 *.jpg *.png")
                print("âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ")
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "ğŸ“„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹"
        
    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        CONTENT_TYPE: ${{ github.event.inputs.content_type }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
        EPISODES: ${{ github.event.inputs.episodes }}
      run: |
        echo "âš¡ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹..."
        python3 upload_script.py
        
    - name: ØªØ³Ø¬ÙŠÙ„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      run: |
        echo "ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ: $(date)"
