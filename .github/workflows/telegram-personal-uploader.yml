# .github/workflows/telegram-auto-uploader.yml

name: Telegram Auto Uploader

on:
  repository_dispatch:
    types: [start-upload]

jobs:
  upload-to-telegram:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† HTML
      run: |
        echo "ğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…:"
        echo "Chat ID: ${{ github.event.client_payload.chat_id }}"
        echo "Content Name: ${{ github.event.client_payload.content_name }}"
        echo "Content Type: ${{ github.event.client_payload.content_type }}"
        echo "Image URL: ${{ github.event.client_payload.image_url }}"
        echo "Video URL: ${{ github.event.client_payload.video_url || 'N/A' }}"
        echo "Skip SSL: ${{ github.event.client_payload.skip_ssl }}"
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ø¹ SSL
      run: |
        echo "ğŸ”§ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©..."
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          curl \
          ffmpeg \
          python3 \
          python3-pip \
          ca-certificates \
          gnupg \
          lsb-release
        
        # ØªØ­Ø¯ÙŠØ« Ø´Ù‡Ø§Ø¯Ø§Øª SSL
        sudo update-ca-certificates
        
        # ØªØ«Ø¨ÙŠØª Telethon
        pip3 install telethon requests
        
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª"
        
    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
      run: |
        cat > auto_uploader.py << 'EOF'
        import asyncio
        import os
        import sys
        import subprocess
        import ssl
        import urllib.request
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        import json
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        API_ID = int(os.environ.get('TELEGRAM_API_ID'))
        API_HASH = os.environ.get('TELEGRAM_API_HASH')
        SESSION_STRING = os.environ.get('TELEGRAM_SESSION_STRING')
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† repository_dispatch
        data = json.loads(os.environ.get('UPLOAD_DATA', '{}'))
        
        CHAT_ID = data.get('chat_id', '')
        CONTENT_NAME = data.get('content_name', '')
        CONTENT_TYPE = data.get('content_type', 'movie')
        IMAGE_URL = data.get('image_url', '')
        VIDEO_URL = data.get('video_url', '')
        SKIP_SSL = data.get('skip_ssl', True)
        EPISODES = data.get('episodes', [])
        
        def log(message, level='INFO'):
            print(f'[{level}] {message}', flush=True)
        
        def download_with_retry(url, filename, skip_ssl=True):
            """ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØªØ¬Ø§ÙˆØ² SSL"""
            log(f'Ø¨Ø¯Ø¡ ØªÙ†Ø²ÙŠÙ„: {filename}')
            
            for attempt in range(3):
                try:
                    # Ø®ÙŠØ§Ø±Ø§Øª wget Ù„ØªØ¬Ø§ÙˆØ² SSL
                    cmd = ['wget']
                    
                    if skip_ssl:
                        cmd.extend([
                            '--no-check-certificate',
                            '--retry-connrefused',
                            '--retry-on-http-error=403,404,500,502,503,504'
                        ])
                    
                    cmd.extend([
                        '--timeout=30',
                        '--tries=3',
                        '--waitretry=5',
                        '--user-agent=Mozilla/5.0',
                        '-O', filename,
                        url
                    ])
                    
                    log(f'Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© {attempt + 1}: {" ".join(cmd)}')
                    
                    result = subprocess.run(cmd, capture_output=True, text=True)
                    
                    if result.returncode == 0:
                        log(f'ØªÙ… ØªÙ†Ø²ÙŠÙ„ {filename} Ø¨Ù†Ø¬Ø§Ø­', 'SUCCESS')
                        return True
                    else:
                        log(f'ÙØ´Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© {attempt + 1}: {result.stderr}', 'WARNING')
                        continue
                        
                except Exception as e:
                    log(f'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© {attempt + 1}: {e}', 'WARNING')
                    continue
            
            log(f'ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ {filename} Ø¨Ø¹Ø¯ 3 Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 'ERROR')
            return False
        
        def get_file_extension(url):
            """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·"""
            import re
            match = re.search(r'\.(mp4|jpg|jpeg|png|webp)$', url.lower())
            return match.group(1) if match else 'jpg'
        
        async def main():
            log('=== Ø¨Ø¯Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ===')
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Telegram
            client = TelegramClient(StringSession(SESSION_STRING), API_ID, API_HASH)
            
            try:
                # Ø§Ù„Ø§ØªØµØ§Ù„
                await client.connect()
                log('âœ… Ù…ØªØµÙ„ Ø¨Ù€ Telegram', 'SUCCESS')
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                import re
                clean_name = re.sub(r'[<>:"/\\|?*]', '', CONTENT_NAME).strip()
                clean_name = re.sub(r'\s+', ' ', clean_name)
                
                # 1. ØªÙ†Ø²ÙŠÙ„ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                image_ext = get_file_extension(IMAGE_URL)
                image_filename = f"{clean_name}_poster.{image_ext}"
                
                if download_with_retry(IMAGE_URL, image_filename, SKIP_SSL):
                    log(f'ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: {image_filename}')
                    await client.send_file(
                        CHAT_ID,
                        image_filename,
                        caption=f'ğŸ¬ {CONTENT_NAME}'
                    )
                    log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'SUCCESS')
                
                # 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠÙ„Ù…
                if CONTENT_TYPE == 'movie' and VIDEO_URL:
                    video_filename = f"{clean_name}.mp4"
                    
                    if download_with_retry(VIDEO_URL, video_filename, SKIP_SSL):
                        log(f'ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {video_filename}')
                        await client.send_file(
                            CHAT_ID,
                            video_filename,
                            caption=f'ğŸ¥ {CONTENT_NAME}\nğŸ“ {video_filename}'
                        )
                        log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ', 'SUCCESS')
                
                # 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ù„Ø³Ù„
                elif CONTENT_TYPE == 'series' and EPISODES:
                    for i, episode in enumerate(EPISODES, 1):
                        if episode.get('url'):
                            episode_filename = f"{clean_name} - Ø§Ù„Ø­Ù„Ù‚Ø© {i}.mp4"
                            
                            if download_with_retry(episode['url'], episode_filename, SKIP_SSL):
                                log(f'ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø© {i}: {episode_filename}')
                                await client.send_file(
                                    CHAT_ID,
                                    episode_filename,
                                    caption=f'ğŸ“º {CONTENT_NAME} - Ø§Ù„Ø­Ù„Ù‚Ø© {i}\nğŸ“ {episode_filename}'
                                )
                                log(f'âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø© {i}', 'SUCCESS')
                                await asyncio.sleep(1)
                
                log('ğŸ‰ ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'SUCCESS')
                
            except Exception as e:
                log(f'âŒ Ø®Ø·Ø£: {str(e)}', 'ERROR')
                sys.exit(1)
                
            finally:
                await client.disconnect()
                log('ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„')
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
                log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©...')
                os.system("rm -f *.mp4 *.jpg *.jpeg *.png *.webp")
                log('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ')
        
        if __name__ == "__main__":
            asyncio.run(main())
        EOF
        
        echo "ğŸ“„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„"
        
    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        UPLOAD_DATA: ${{ toJson(github.event.client_payload) }}
      run: |
        echo "âš¡ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©..."
        python3 auto_uploader.py
        
    - name: Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ø¬Ø§Ø­
      run: |
        echo "âœ… ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: $(date)"
