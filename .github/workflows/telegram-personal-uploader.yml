name: Telegram Personal Uploader

on:
  workflow_dispatch:
    inputs:
      chat_id:
        description: 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† @username Ø£Ùˆ Ø±Ù‚Ù… Ù‡Ø§ØªÙ)'
        required: true
        type: string
      content_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù… Ø£Ùˆ Ø§Ù„Ù…Ø³Ù„Ø³Ù„'
        required: true
        type: string
      content_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰'
        required: true
        type: choice
        options:
        - movie
        - series
        default: movie
      image_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„ØºÙ„Ø§Ù)'
        required: true
        type: string
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù„Ù„ÙÙŠÙ„Ù…)'
        required: false
        type: string
      file_extension:
        description: 'ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù'
        required: true
        type: string
        default: '.mp4'
      series_files:
        description: 'Ø±ÙˆØ§Ø¨Ø· Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ù„Ø³Ù„ (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)'
        required: false
        type: string

jobs:
  upload-to-telegram:
    runs-on: ubuntu-latest
    
    steps:
    - name: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø©
      run: |
        echo "Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Telegram Ø§Ù„Ø´Ø®ØµÙŠ"
        echo "Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${{ github.event.inputs.content_name }}"
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg curl wget python3-pip
        
    - name: ØªØ«Ø¨ÙŠØª Telethon
      run: |
        pip3 install telethon
        
    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Python Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø­Ø³Ø§Ø¨ Telegram Ø§Ù„Ø´Ø®ØµÙŠ
      env:
        PHONE_NUMBER: ${{ secrets.TELEGRAM_PHONE }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
        CONTENT_TYPE: ${{ github.event.inputs.content_type }}
        FILE_EXTENSION: ${{ github.event.inputs.file_extension }}
      run: |
        cat > telegram_upload.py << 'EOF'
        import asyncio
        from telethon import TelegramClient
        from telethon.errors import SessionPasswordNeededError
        import os
        import sys
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Secrets
        api_id = int(os.environ.get('TELEGRAM_API_ID', '0'))
        api_hash = os.environ.get('TELEGRAM_API_HASH', '')
        phone_number = os.environ.get('PHONE_NUMBER', '')
        password = os.environ.get('TELEGRAM_PASSWORD', '')
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† GitHub Actions inputs
        chat_id = os.environ.get('CHAT_ID', '')
        content_name = os.environ.get('CONTENT_NAME', '')
        image_url = os.environ.get('IMAGE_URL', '')
        video_url = os.environ.get('VIDEO_URL', '')
        content_type = os.environ.get('CONTENT_TYPE', 'movie')
        file_extension = os.environ.get('FILE_EXTENSION', '.mp4')
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
        client = TelegramClient('session_name', api_id, api_hash)
        
        async def main():
            await client.start(phone=phone_number)
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ­ØªØ§Ø¬ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†)
            if not await client.is_user_authorized():
                try:
                    await client.send_code_request(phone_number)
                    
                    # Ù‡Ù†Ø§ ÙÙŠ Ø¨ÙŠØ¦Ø© GitHub ActionsØŒ Ø³Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§
                    # Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø«Ø§Ø¨Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆÙØ±Ù‹Ø§ ÙÙŠ Secrets
                    code = os.environ.get('TELEGRAM_CODE', '')
                    
                    if code:
                        await client.sign_in(phone_number, code)
                    else:
                        print("ERROR: ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø·Ù„ÙˆØ¨. Ø£Ø¶ÙÙ‡ ÙÙŠ TELEGRAM_CODE secret")
                        sys.exit(1)
                        
                except SessionPasswordNeededError:
                    if password:
                        await client.sign_in(password=password)
                    else:
                        print("ERROR: ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†")
                        sys.exit(1)
            
            print(f"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨: {phone_number}")
            
            # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            print("ðŸ“¥ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...")
            os.system(f"wget -O 'poster{file_extension}' '{image_url}'")
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©
            print("ðŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...")
            await client.send_file(
                chat_id,
                f'poster{file_extension}',
                caption=f'ðŸŽ¬ {content_name}\n\nâœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± GitHub Actions'
            )
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠÙ„Ù…
            if content_type == 'movie' and video_url:
                print("ðŸŽ¥ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠÙ„Ù…...")
                video_name = f"{content_name}{file_extension}"
                os.system(f"wget -O '{video_name}' '{video_url}'")
                
                print(f"ðŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠÙ„Ù…: {video_name}")
                await client.send_file(
                    chat_id,
                    video_name,
                    caption=f'ðŸŽ¥ {content_name}\nðŸ“ {video_name}'
                )
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ù„Ø³Ù„
            elif content_type == 'series':
                series_files = os.environ.get('SERIES_FILES', '')
                if series_files:
                    files = series_files.split(',')
                    for i, file_url in enumerate(files, 1):
                        if file_url.strip():
                            episode_name = f"{content_name} - Ø§Ù„Ø­Ù„Ù‚Ø© {i}{file_extension}"
                            print(f"ðŸ“¥ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© {i}: {episode_name}")
                            os.system(f"wget -O '{episode_name}' '{file_url.strip()}'")
                            
                            print(f"ðŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø© {i}")
                            await client.send_file(
                                chat_id,
                                episode_name,
                                caption=f'ðŸ“º {content_name} - Ø§Ù„Ø­Ù„Ù‚Ø© {i}\nðŸ“ {episode_name}'
                            )
                            await asyncio.sleep(2)  # ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø­Ù„Ù‚Ø§Øª
            
            print("âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!")
            await client.disconnect()
        
        if __name__ == '__main__':
            asyncio.run(main())
        EOF
        
    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
        TELEGRAM_CODE: ${{ secrets.TELEGRAM_CODE }}
        TELEGRAM_PASSWORD: ${{ secrets.TELEGRAM_PASSWORD }}
        CHAT_ID: ${{ github.event.inputs.chat_id }}
        CONTENT_NAME: ${{ github.event.inputs.content_name }}
        IMAGE_URL: ${{ github.event.inputs.image_url }}
        VIDEO_URL: ${{ github.event.inputs.video_url }}
        CONTENT_TYPE: ${{ github.event.inputs.content_type }}
        FILE_EXTENSION: ${{ github.event.inputs.file_extension }}
        SERIES_FILES: ${{ github.event.inputs.series_files }}
      run: |
        python3 telegram_upload.py
        
    - name: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      run: |
        rm -f *.mp4 *.mkv *.avi *.mov *.webm *.jpg *.png
        echo "ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©"
