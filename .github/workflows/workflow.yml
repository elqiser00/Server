name: Upload Media to Telegram

on:
  workflow_dispatch:
    inputs:
      channel_url:
        description: 'ุฑุงุจุท ุงูููุงุฉ (ูุซุงู: @channel ุฃู +123456789 ุฃู https://t.me/channel)'
        required: true
        type: string
      media_type:
        description: 'ููุน ุงููุญุชูู'
        required: true
        default: 'ุฃููุงู'
        type: choice
        options:
          - ุฃููุงู
          - ูุณูุณูุงุช
      logo_url:
        description: 'ุฑุงุจุท ุตูุฑุฉ ุงูุดุนุงุฑ (ุงุฎุชูุงุฑู)'
        required: false
        type: string
      video_paths:
        description: 'ุฑูุงุจุท ุงูููุฏูู (ููุตููุฉ ุจููุงุตู)'
        required: true
        type: string
      caption:
        description: 'ุงููุต ุงูุชูุถูุญู (ุงุฎุชูุงุฑู)'
        required: false
        type: string

env:
  PYTHONUNBUFFERED: "1"

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ๐ฅ ุงุณุชุนุฑุงุถ ุงูููุฏ
      uses: actions/checkout@v4
      
    - name: ๐ ุฅุนุฏุงุฏ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ๐ฆ ุชุซุจูุช ุงููุชุทูุจุงุช
      run: |
        python -m pip install --upgrade pip
        pip install telethon==1.34.0
        pip install aiohttp==3.9.1
        pip install python-dotenv==1.0.0
        
    - name: ๐๏ธ ุฅูุดุงุก ูุฌูุฏุงุช
      run: |
        mkdir -p sessions downloads
        
    - name: ๐ง ุฅุนุฏุงุฏ ุงูุฌูุณุฉ (ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ)
      if: ${{ !secrets.TELEGRAM_SESSION_STRING }}
      run: |
        echo "โ๏ธ  TELEGRAM_SESSION_STRING ุบูุฑ ููุฌูุฏ"
        echo "ุณูุชู ูุญุงููุฉ ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ..."
        echo "ูุฏ ุชุญุชุงุฌ ูุชุณุฌูู ุงูุฏุฎูู ูุฏููุงู"
        
    - name: ๐ ุฑูุน ุงููููุงุช
      env:
        # ุงูุฃุณุฑุงุฑ ุงููุทููุจุฉ
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
        TELEGRAM_PASSWORD: ${{ secrets.TELEGRAM_PASSWORD || '' }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING || '' }}
        
        # ูุฏุฎูุงุช ุงููุณุชุฎุฏู
        INPUT_CHANNEL_URL: ${{ inputs.channel_url }}
        INPUT_MEDIA_TYPE: ${{ inputs.media_type }}
        INPUT_LOGO_URL: ${{ inputs.logo_url }}
        INPUT_VIDEO_PATHS: ${{ inputs.video_paths }}
        INPUT_CAPTION: ${{ inputs.caption }}
      run: |
        echo "========================================"
        echo "๐ ุจุฏุก ุฑูุน ุงููููุงุช ุฅูู ุงูุชููุฌุฑุงู"
        echo "========================================"
        echo "ุงูููุงุฉ: ${{ inputs.channel_url }}"
        echo "ุงูููุน: ${{ inputs.media_type }}"
        echo "ุงูุดุนุงุฑ: ${{ inputs.logo_url || 'ูุง ููุฌุฏ' }}"
        echo "ุงููุตู: ${{ inputs.caption || 'ูุง ููุฌุฏ' }}"
        echo "ุงููููุงุช: $(echo '${{ inputs.video_paths }}' | tr ',' '\n' | wc -l)"
        echo "========================================"
        
        # ุชุดุบูู ุงูุจุฑูุงูุฌ
        python main.py
        
    - name: ๐ ุญูุธ ุงูุณุฌูุงุช
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: uploader-logs
        path: |
          uploader.log
          sessions/
          downloads/
        retention-days: 7
        
    - name: ๐ ูุชูุฌุฉ ุงูุฑูุน
      if: always()
      run: |
        echo "========================================"
        echo "๐ $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "โ ุชู ุฑูุน ุงููููุงุช ุจูุฌุงุญ!"
        else
          echo "โ ูุดูุช ุนูููุฉ ุงูุฑูุน"
          echo ""
          echo "๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:"
          echo ""
          
          # ูุฑุงุกุฉ ุขุฎุฑ 20 ุณุทุฑ ูู ุงูุณุฌู
          if [ -f uploader.log ]; then
            echo "๐ ุขุฎุฑ 20 ุณุทุฑ ูู ุงูุณุฌูุงุช:"
            echo "----------------------------------------"
            tail -20 uploader.log || echo "โ๏ธ  ูุง ูููู ูุฑุงุกุฉ ุงูุณุฌูุงุช"
            echo "----------------------------------------"
          else
            echo "โ๏ธ  ููู ุงูุณุฌูุงุช ุบูุฑ ููุฌูุฏ"
          fi
          
          echo ""
          echo "๐ก ุงูุญููู ุงูููุชุฑุญุฉ:"
          echo "1. ุชุฃูุฏ ูู ุตุญุฉ ุงูุฃุณุฑุงุฑ ูู GitHub Secrets"
          echo "2. ุงุณุชุฎุฏู TELEGRAM_SESSION_STRING ูุชุฌูุจ ุชุณุฌูู ุงูุฏุฎูู"
          echo "3. ุชุฃูุฏ ุฃู ุงูุญุณุงุจ ุนุถู ูู ุงูููุงุฉ"
          echo "4. ุฌุฑุจ ุงูุฑูุงุจุท ูู ุงููุชุตูุญ ููุชุฃูุฏ ูู ุตุญุชูุง"
          echo "5. ุชุญูู ูู ุฃู ุงูุญุณุงุจ ููุนู ููู ุตูุงุญูุฉ ุงููุดุฑ"
        fi
        
        echo "========================================"
