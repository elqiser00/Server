name: Upload Media to Telegram

on:
  workflow_dispatch:
    inputs:
      channel_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© (Ù…Ø«Ø§Ù„: @channel Ø£Ùˆ +123456789 Ø£Ùˆ https://t.me/channel)'
        required: true
        type: string
      media_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰'
        required: true
        default: 'Ø£ÙÙ„Ø§Ù…'
        type: choice
        options:
          - Ø£ÙÙ„Ø§Ù…
          - Ù…Ø³Ù„Ø³Ù„Ø§Øª
      logo_url:
        description: 'Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string
      video_paths:
        description: 'Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)'
        required: true
        type: string
      caption:
        description: 'Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string

env:
  PYTHONUNBUFFERED: "1"

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        python -m pip install --upgrade pip
        pip install telethon==1.34.0
        pip install aiohttp==3.9.1
        pip install python-dotenv==1.0.0
        
    - name: ğŸ—‚ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª
      run: |
        mkdir -p sessions downloads
        
    - name: ğŸ”§ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø±ÙŠØªØ³
      run: |
        echo "ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..."
        echo "API_ID: ${{ secrets.TELEGRAM_API_ID != '' && 'âœ…' || 'âŒ' }}"
        echo "API_HASH: ${{ secrets.TELEGRAM_API_HASH != '' && 'âœ…' || 'âŒ' }}"
        echo "PHONE: ${{ secrets.TELEGRAM_PHONE != '' && 'âœ…' || 'âŒ' }}"
        echo "SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING != '' && 'âœ…' || 'âŒ' }}"
        
        if [ -z "${{ secrets.TELEGRAM_API_ID }}" ] || [ -z "${{ secrets.TELEGRAM_API_HASH }}" ] || [ -z "${{ secrets.TELEGRAM_PHONE }}" ]; then
          echo "âŒ Ø£Ø³Ø±Ø§Ø± GitHub ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©!"
          echo "ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ©: TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_PHONE"
          exit 1
        fi
        
    - name: ğŸš€ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
      env:
        # Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
        TELEGRAM_PASSWORD: ${{ secrets.TELEGRAM_PASSWORD || '' }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING || '' }}
        
        # Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        INPUT_CHANNEL_URL: ${{ inputs.channel_url }}
        INPUT_MEDIA_TYPE: ${{ inputs.media_type }}
        INPUT_LOGO_URL: ${{ inputs.logo_url }}
        INPUT_VIDEO_PATHS: ${{ inputs.video_paths }}
        INPUT_CAPTION: ${{ inputs.caption }}
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘      ğŸš€ TELEGRAM MEDIA UPLOADER v4.0             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“¢ Ø§Ù„Ù‚Ù†Ø§Ø©: ${{ inputs.channel_url }}"
        echo "ğŸ¬ Ø§Ù„Ù†ÙˆØ¹: ${{ inputs.media_type }}"
        echo "ğŸ–¼ï¸  Ø§Ù„Ø´Ø¹Ø§Ø±: ${{ inputs.logo_url || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}"
        echo "ğŸ“ Ø§Ù„ÙˆØµÙ: ${{ inputs.caption || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}"
        
        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª
        FILE_COUNT=$(echo '${{ inputs.video_paths }}' | tr ',' '\n' | wc -l)
        echo "ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: $FILE_COUNT"
        echo ""
        echo "================================================="
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        python main.py
        
        EXIT_CODE=$?
        
        echo ""
        echo "================================================="
        echo "Ø±Ù…Ø² Ø§Ù„Ø®Ø±ÙˆØ¬: $EXIT_CODE"
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!"
        else
          echo "âŒ ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"
        fi
        
        exit $EXIT_CODE
        
    - name: ğŸ“ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: uploader-logs
        path: |
          uploader.log
          sessions/
        retention-days: 7
        
    - name: ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo "================================================="
        echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
        echo "================================================="
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!"
        else
          echo "âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹"
          echo ""
          
          if [ -f uploader.log ]; then
            echo "ğŸ“„ Ø¢Ø®Ø± 10 Ø£Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª:"
            echo "----------------------------------------"
            tail -10 uploader.log || echo "âš ï¸  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª"
            echo "----------------------------------------"
          fi
          
          echo ""
          echo "ğŸ” Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:"
          echo "1. ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø£Ø³Ø±Ø§Ø± ÙÙŠ GitHub Secrets"
          echo "2. ØªØ£ÙƒØ¯ Ù…Ù† TELEGRAM_SESSION_STRING"
          echo "3. Ø¬Ø±Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"
          echo "4. ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª"
        fi
